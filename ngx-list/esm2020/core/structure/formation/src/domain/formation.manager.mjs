import { RowSelectToggleType } from './row-select-toggle-type';
import { RowSelectionMode, RowSelectionType } from '../api/row-selected/row-selection';
import { FormationSelection } from './selection/formation.selection';
import { SelectionModeSetAggregateEvent } from '../core/mode/selection-mode-set.aggregate-event';
import { SelectionTypeSetAggregateEvent } from '../core/type/selection-type-set.aggregate-event';
import { SelectionEnabledSetAggregateEvent } from '../core/set-enabled/selection-enabled-set.aggregate-event';
import { ItemEntityId } from '../../../source/src/domain/item/item.entity-id';
export class FormationManager {
    constructor(id, selectedItemIds) {
        this.id = id;
        this.selectedItemIds = selectedItemIds;
        this.selection = new FormationSelection(RowSelectionMode.SINGLE, RowSelectionType.ROW);
        this.matcher = (item) => item.id;
    }
    init(enabled, mode, type) {
        this.enabled = enabled;
        this.selection.setMode(mode);
        this.selection.setType(type);
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled),
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setSelection(enabled) {
        this.enabled = enabled;
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled)
        ];
    }
    setMode(mode) {
        this.selection.setMode(mode);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setType(type) {
        this.selection.setType(type);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setMatcher(matcher) {
        this.matcher = matcher;
    }
    isAllSelected() {
        return this.allSelected;
    }
    isAllUnselected() {
        return this.allUnselected;
    }
    getSelectedItemIds() {
        return Array.from(this.selectedItemIds).map(id => new ItemEntityId(id));
    }
    selectAll(allEntityIds) {
        this.selectedItemIds = new Set(allEntityIds.map(entity => entity.toString()));
        this.allSelected = true;
        this.allUnselected = false;
    }
    unselectAll() {
        this.selectedItemIds.clear();
        this.allSelected = false;
        this.allUnselected = true;
    }
    reSelectByIds(itemEntities) {
        this.selectByIds(this.getSelectedItemIds().map(i => i.getId()), itemEntities);
    }
    selectByIds(ids, itemEntities) {
        if (!this.enabled) {
            return;
        }
        const itemIds = [];
        for (let i = 0; i < ids.length; i++) {
            const items = itemEntities
                .filter((item) => {
                return this.matcher(item.getSourceItem()) === ids[i];
            })
                .map((item) => item.getId().toString());
            itemIds.push(...items);
        }
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(itemEntities.map(i => i.getId()));
        this.calculateAllUnselected();
    }
    selectByIndex(indexes, allEntityIds) {
        if (!this.enabled) {
            return;
        }
        const itemIds = indexes.map((i) => {
            if (!allEntityIds[i]) {
                console.error('Item not found');
            }
            return allEntityIds[i].toString();
        });
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(allEntityIds);
        this.calculateAllUnselected();
    }
    selectRows(itemIds, itemEntityIds) {
    }
    toggleRow(itemId, type, itemEntityIds) {
        if (!this.enabled) {
            return;
        }
        if (type === RowSelectToggleType.ADD && this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        this.toggleRowByType(type, itemId);
        this.calculateAllSelected(itemEntityIds);
        this.calculateAllUnselected();
    }
    calculateAllSelected(itemEntityIds) {
        if (itemEntityIds.length !== this.selectedItemIds.size) {
            this.allSelected = false;
        }
        else {
            const rows = Array.from(this.selectedItemIds);
            let equal = true;
            rows.sort();
            itemEntityIds.sort();
            for (let i = 0; i < rows.length; i += 1) {
                if (rows[i] !== itemEntityIds[i].toString()) {
                    equal = false;
                    break;
                }
            }
            this.allSelected = equal;
        }
    }
    calculateAllUnselected() {
        this.allUnselected = this.selectedItemIds.size === 0;
    }
    unselectRow(itemEntityId) {
        if (this.selectedItemIds.has(itemEntityId.toString())) {
            this.selectedItemIds.delete(itemEntityId.toString());
        }
    }
    getId() {
        return this.id;
    }
    getType() {
        return this.selection.getType();
    }
    toggleRowByType(type, itemId) {
        switch (type) {
            case RowSelectToggleType.NONE:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.clear();
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.ADD:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.RANGE:
                break;
            default:
                break;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0aW9uLm1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9idWlsZC1jbGkvcHJvamVjdHMvbmd4LWxpc3Qvc3JjL2NvcmUvc3RydWN0dXJlL2Zvcm1hdGlvbi9zcmMvZG9tYWluL2Zvcm1hdGlvbi5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRXJFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRWpHLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxNQUFNLDJEQUEyRCxDQUFDO0FBQzlHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUc5RSxNQUFNLE9BQU8sZ0JBQWdCO0lBWTVCLFlBQW9CLEVBQWUsRUFDeEIsZUFBNEI7UUFEbkIsT0FBRSxHQUFGLEVBQUUsQ0FBYTtRQUN4QixvQkFBZSxHQUFmLGVBQWUsQ0FBYTtRQVQvQixjQUFTLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFNbEYsWUFBTyxHQUF1QixDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUk3RCxDQUFDO0lBRUQsSUFBSSxDQUFDLE9BQWdCLEVBQUUsSUFBc0IsRUFBRSxJQUFzQjtRQUNwRSxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8s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UUFBUSxFQUFFLENBQUMsRUFBRTtZQUN0RCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUNyRDtJQUNGLENBQUM7SUFFRCxLQUFLO1FBQ0osT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxPQUFPO1FBQ04sT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFTyxlQUFlLENBQUMsSUFBeUIsRUFBRSxNQUFjO1FBRWhFLFFBQVEsSUFBSSxFQUFFO1lBQ2IsS0FBSyxtQkFBbUIsQ0FBQyxJQUFJO2dCQUU1QixJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUNyQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDcEM7cUJBQU07b0JBQ04sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDN0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2pDO2dCQUVELE1BQU07WUFFUCxLQUFLLG1CQUFtQixDQUFDLEdBQUc7Z0JBRTNCLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3JDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNwQztxQkFBTTtvQkFDTixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDakM7Z0JBRUQsTUFBTTtZQUVQLEtBQUssbUJBQW1CLENBQUMsS0FBSztnQkFFN0IsTUFBTTtZQUVQO2dCQUNDLE1BQU07U0FDUDtJQUNGLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvd1NlbGVjdFRvZ2dsZVR5cGUgfSBmcm9tICcuL3Jvdy1zZWxlY3QtdG9nZ2xlLXR5cGUnO1xuaW1wb3J0IHsgUm93U2VsZWN0aW9uTW9kZSwgUm93U2VsZWN0aW9uVHlwZSB9IGZyb20gJy4uL2FwaS9yb3ctc2VsZWN0ZWQvcm93LXNlbGVjdGlvbic7XG5pbXBvcnQgeyBGb3JtYXRpb25TZWxlY3Rpb24gfSBmcm9tICcuL3NlbGVjdGlvbi9mb3JtYXRpb24uc2VsZWN0aW9uJztcbmltcG9ydCB7IFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50IH0gZnJvbSAnLi4vLi4vLi4vc3RydWN0dXJlLWNvcmUvc3JjL2NvcmUvc3RydWN0dXJlLmFnZ3JlZ2F0ZS1ldmVudCc7XG5pbXBvcnQgeyBTZWxlY3Rpb25Nb2RlU2V0QWdncmVnYXRlRXZlbnQgfSBmcm9tICcuLi9jb3JlL21vZGUvc2VsZWN0aW9uLW1vZGUtc2V0LmFnZ3JlZ2F0ZS1ldmVudCc7XG5pbXBvcnQgeyBTdHJ1Y3R1cmVJZCB9IGZyb20gJy4uLy4uLy4uL3N0cnVjdHVyZS1jb3JlL3NyYy9hcGkvZ2xvYmFsL3N0cnVjdHVyZS5pZCc7XG5pbXBvcnQgeyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQgfSBmcm9tICcuLi9jb3JlL3R5cGUvc2VsZWN0aW9uLXR5cGUtc2V0LmFnZ3JlZ2F0ZS1ldmVudCc7XG5pbXBvcnQgeyBTZWxlY3Rpb25FbmFibGVkU2V0QWdncmVnYXRlRXZlbnQgfSBmcm9tICcuLi9jb3JlL3NldC1lbmFibGVkL3NlbGVjdGlvbi1lbmFibGVkLXNldC5hZ2dyZWdhdGUtZXZlbnQnO1xuaW1wb3J0IHsgSXRlbUVudGl0eUlkIH0gZnJvbSAnLi4vLi4vLi4vc291cmNlL3NyYy9kb21haW4vaXRlbS9pdGVtLmVudGl0eS1pZCc7XG5pbXBvcnQgeyBJdGVtRW50aXR5IH0gZnJvbSAnLi4vLi4vLi4vc291cmNlL3NyYy9kb21haW4vaXRlbS9pdGVtLmVudGl0eSc7XG5cbmV4cG9ydCBjbGFzcyBGb3JtYXRpb25NYW5hZ2VyIHtcblxuXHRwcml2YXRlIGVuYWJsZWQ6IGJvb2xlYW47XG5cblx0cHJpdmF0ZSBzZWxlY3Rpb24gPSBuZXcgRm9ybWF0aW9uU2VsZWN0aW9uKFJvd1NlbGVjdGlvbk1vZGUuU0lOR0xFLCBSb3dTZWxlY3Rpb25UeXBlLlJPVyk7XG5cblx0cHJpdmF0ZSBhbGxTZWxlY3RlZDogYm9vbGVhbjtcblxuXHRwcml2YXRlIGFsbFVuc2VsZWN0ZWQ6IGJvb2xlYW47XG5cblx0cHJpdmF0ZSBtYXRjaGVyOiAoaXRlbTogYW55KSA9PiBhbnkgPSAoaXRlbTogYW55KSA9PiBpdGVtLmlkO1xuXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgaWQ6IFN0cnVjdHVyZUlkLFxuXHRcdFx0XHRwcml2YXRlIHNlbGVjdGVkSXRlbUlkczogU2V0PHN0cmluZz4pIHtcblx0fVxuXG5cdGluaXQoZW5hYmxlZDogYm9vbGVhbiwgbW9kZTogUm93U2VsZWN0aW9uTW9kZSwgdHlwZTogUm93U2VsZWN0aW9uVHlwZSk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5lbmFibGVkID0gZW5hYmxlZDtcblx0XHR0aGlzLnNlbGVjdGlvbi5zZXRNb2RlKG1vZGUpO1xuXHRcdHRoaXMuc2VsZWN0aW9uLnNldFR5cGUodHlwZSk7XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0bmV3IFNlbGVjdGlvbkVuYWJsZWRTZXRBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIHRoaXMuZW5hYmxlZCksXG5cdFx0XHRuZXcgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0TW9kZSgpKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCkpXG5cdFx0XTtcblx0fVxuXG5cdHNldFNlbGVjdGlvbihlbmFibGVkOiBib29sZWFuKTogQXJyYXk8U3RydWN0dXJlQWdncmVnYXRlRXZlbnQ+IHtcblx0XHR0aGlzLmVuYWJsZWQgPSBlbmFibGVkO1xuXG5cdFx0cmV0dXJuIFtcblx0XHRcdG5ldyBTZWxlY3Rpb25FbmFibGVkU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLmVuYWJsZWQpXG5cdFx0XTtcblx0fVxuXG5cdHNldE1vZGUobW9kZTogUm93U2VsZWN0aW9uTW9kZSk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0TW9kZShtb2RlKTtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0TW9kZSgpKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCkpXG5cdFx0XTtcblx0fVxuXG5cdHNldFR5cGUodHlwZTogUm93U2VsZWN0aW9uVHlwZSk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0VHlwZSh0eXBlKTtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0TW9kZSgpKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCkpXG5cdFx0XTtcblx0fVxuXG5cdHNldE1hdGNoZXIobWF0Y2hlcjogKGl0ZW06IGFueSkgPT4gYW55KTogdm9pZCB7XG5cdFx0dGhpcy5tYXRjaGVyID0gbWF0Y2hlcjtcblx0fVxuXG5cdGlzQWxsU2VsZWN0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuYWxsU2VsZWN0ZWQ7XG5cdH1cblxuXHRpc0FsbFVuc2VsZWN0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuYWxsVW5zZWxlY3RlZDtcblx0fVxuXG5cdGdldFNlbGVjdGVkSXRlbUlkcygpOiBBcnJheTxJdGVtRW50aXR5SWQ+IHtcblx0XHRyZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnNlbGVjdGVkSXRlbUlkcykubWFwKGlkID0+IG5ldyBJdGVtRW50aXR5SWQoaWQpKTtcblx0fVxuXG5cdHNlbGVjdEFsbChhbGxFbnRpdHlJZHM6IEFycmF5PEl0ZW1FbnRpdHlJZD4pOiB2b2lkIHtcblx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcyA9IG5ldyBTZXQ8c3RyaW5nPihhbGxFbnRpdHlJZHMubWFwKGVudGl0eSA9PiBlbnRpdHkudG9TdHJpbmcoKSkpO1xuXHRcdHRoaXMuYWxsU2VsZWN0ZWQgPSB0cnVlO1xuXHRcdHRoaXMuYWxsVW5zZWxlY3RlZCA9IGZhbHNlO1xuXHR9XG5cblx0dW5zZWxlY3RBbGwoKTogdm9pZCB7XG5cdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuY2xlYXIoKTtcblx0XHR0aGlzLmFsbFNlbGVjdGVkID0gZmFsc2U7XG5cdFx0dGhpcy5hbGxVbnNlbGVjdGVkID0gdHJ1ZTtcblx0fVxuXG5cdHJlU2VsZWN0QnlJZHMoaXRlbUVudGl0aWVzOiBBcnJheTxJdGVtRW50aXR5Pik6IHZvaWQge1xuXHRcdHRoaXMuc2VsZWN0QnlJZHModGhpcy5nZXRTZWxlY3RlZEl0ZW1JZHMoKS5tYXAoaSA9PiBpLmdldElkKCkpLCBpdGVtRW50aXRpZXMpXG5cdH1cblxuXHRzZWxlY3RCeUlkcyhpZHM6IEFycmF5PHN0cmluZz4sIGl0ZW1FbnRpdGllczogQXJyYXk8SXRlbUVudGl0eT4pOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMuZW5hYmxlZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IGl0ZW1JZHMgPSBbXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSArKykge1xuXHRcdFx0Y29uc3QgaXRlbXMgPSBpdGVtRW50aXRpZXNcblx0XHRcdFx0LmZpbHRlcigoaXRlbTogSXRlbUVudGl0eSkgPT4ge1xuXHRcdFx0XHRcdHJldHVybiB0aGlzLm1hdGNoZXIoaXRlbS5nZXRTb3VyY2VJdGVtKCkpID09PSBpZHNbaV07XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5tYXAoKGl0ZW0pID0+IGl0ZW0uZ2V0SWQoKS50b1N0cmluZygpKTtcblxuXHRcdFx0aXRlbUlkcy5wdXNoKC4uLml0ZW1zKTtcblx0XHR9XG5cblx0XHRsZXQgdHlwZSA9IFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREO1xuXG5cdFx0aWYgKHRoaXMuc2VsZWN0aW9uLmlzU2luZ2xlKCkpIHtcblx0XHRcdHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU7XG5cdFx0fVxuXG5cdFx0aXRlbUlkcy5mb3JFYWNoKChpZCkgPT4ge1xuXHRcdFx0dGhpcy50b2dnbGVSb3dCeVR5cGUodHlwZSwgaWQpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXRpZXMubWFwKGkgPT4gaS5nZXRJZCgpKSk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxVbnNlbGVjdGVkKCk7XG5cdH1cblxuXHRzZWxlY3RCeUluZGV4KGluZGV4ZXM6IEFycmF5PG51bWJlcj4sIGFsbEVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXHRcdGlmICghdGhpcy5lbmFibGVkKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Y29uc3QgaXRlbUlkcyA9IGluZGV4ZXMubWFwKChpKSA9PiB7XG5cdFx0XHRpZiAoIWFsbEVudGl0eUlkc1tpXSkge1xuXHRcdFx0XHRjb25zb2xlLmVycm9yKCdJdGVtIG5vdCBmb3VuZCcpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGFsbEVudGl0eUlkc1tpXS50b1N0cmluZygpO1xuXHRcdH0pO1xuXG5cdFx0bGV0IHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLkFERDtcblxuXHRcdGlmICh0aGlzLnNlbGVjdGlvbi5pc1NpbmdsZSgpKSB7XG5cdFx0XHR0eXBlID0gUm93U2VsZWN0VG9nZ2xlVHlwZS5OT05FO1xuXHRcdH1cblxuXHRcdGl0ZW1JZHMuZm9yRWFjaCgoaWQpID0+IHtcblx0XHRcdHRoaXMudG9nZ2xlUm93QnlUeXBlKHR5cGUsIGlkKTtcblx0XHR9KTtcblxuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoYWxsRW50aXR5SWRzKTtcblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTtcblx0fVxuXG5cdHNlbGVjdFJvd3MoaXRlbUlkczogQXJyYXk8c3RyaW5nPiwgaXRlbUVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXG5cdH1cblxuXHR0b2dnbGVSb3coaXRlbUlkOiBzdHJpbmcsIHR5cGU6IFJvd1NlbGVjdFRvZ2dsZVR5cGUsIGl0ZW1FbnRpdHlJZHM6IEFycmF5PEl0ZW1FbnRpdHlJZD4pOiB2b2lkIHtcblxuXHRcdGlmICghdGhpcy5lbmFibGVkKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09IFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREICYmIHRoaXMuc2VsZWN0aW9uLmlzU2luZ2xlKCkpIHtcblx0XHRcdHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU7XG5cdFx0fVxuXG5cdFx0dGhpcy50b2dnbGVSb3dCeVR5cGUodHlwZSwgaXRlbUlkKTtcblxuXHRcdHRoaXMuY2FsY3VsYXRlQWxsU2VsZWN0ZWQoaXRlbUVudGl0eUlkcyk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxVbnNlbGVjdGVkKCk7XG5cdH1cblxuXHRjYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cblx0XHRpZiAoaXRlbUVudGl0eUlkcy5sZW5ndGggIT09IHRoaXMuc2VsZWN0ZWRJdGVtSWRzLnNpemUpIHtcblx0XHRcdHRoaXMuYWxsU2VsZWN0ZWQgPSBmYWxzZTtcblx0XHR9IGVsc2Uge1xuXG5cdFx0XHRjb25zdCByb3dzID0gQXJyYXkuZnJvbSh0aGlzLnNlbGVjdGVkSXRlbUlkcyk7XG5cdFx0XHRsZXQgZXF1YWwgPSB0cnVlO1xuXG5cdFx0XHRyb3dzLnNvcnQoKTtcblx0XHRcdGl0ZW1FbnRpdHlJZHMuc29ydCgpO1xuXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvd3MubGVuZ3RoOyBpICs9IDEpIHtcblx0XHRcdFx0aWYgKHJvd3NbaV0gIT09IGl0ZW1FbnRpdHlJZHNbaV0udG9TdHJpbmcoKSkge1xuXHRcdFx0XHRcdGVxdWFsID0gZmFsc2U7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0dGhpcy5hbGxTZWxlY3RlZCA9IGVxdWFsO1xuXHRcdH1cblx0fVxuXG5cdGNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTogdm9pZCB7XG5cdFx0dGhpcy5hbGxVbnNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZEl0ZW1JZHMuc2l6ZSA9PT0gMDtcblx0fVxuXG5cdHVuc2VsZWN0Um93KGl0ZW1FbnRpdHlJZDogSXRlbUVudGl0eUlkKTogdm9pZCB7XG5cdFx0aWYgKHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmhhcyhpdGVtRW50aXR5SWQudG9TdHJpbmcoKSkpIHtcblx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmRlbGV0ZShpdGVtRW50aXR5SWQudG9TdHJpbmcoKSk7XG5cdFx0fVxuXHR9XG5cblx0Z2V0SWQoKTogU3RydWN0dXJlSWQge1xuXHRcdHJldHVybiB0aGlzLmlkO1xuXHR9XG5cblx0Z2V0VHlwZSgpOiBSb3dTZWxlY3Rpb25UeXBlIHtcblx0XHRyZXR1cm4gdGhpcy5zZWxlY3Rpb24uZ2V0VHlwZSgpO1xuXHR9XG5cblx0cHJpdmF0ZSB0b2dnbGVSb3dCeVR5cGUodHlwZTogUm93U2VsZWN0VG9nZ2xlVHlwZSwgaXRlbUlkOiBzdHJpbmcpIHtcblxuXHRcdHN3aXRjaCAodHlwZSkge1xuXHRcdFx0Y2FzZSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU6XG5cblx0XHRcdFx0aWYgKHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmhhcyhpdGVtSWQpKSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuZGVsZXRlKGl0ZW1JZCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuY2xlYXIoKTtcblx0XHRcdFx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcy5hZGQoaXRlbUlkKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRjYXNlIFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREOlxuXG5cdFx0XHRcdGlmICh0aGlzLnNlbGVjdGVkSXRlbUlkcy5oYXMoaXRlbUlkKSkge1xuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmRlbGV0ZShpdGVtSWQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmFkZChpdGVtSWQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgUm93U2VsZWN0VG9nZ2xlVHlwZS5SQU5HRTpcblxuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG59XG4iXX0=