import { Injectable } from '@angular/core';
import { CompositionWarehouse } from '../../../../composition/core/api/composition.warehouse';
import { hermesFilter, hermesMap, hermesSwitchMap, hermesTake } from '@generic-ui/hermes';
import { FilterWarehouse } from '../api/filter.warehouse';
import { FieldId } from '../../../field/core/domain/field/field.id';
import { FilterCommandInvoker } from '../api/filter.command-invoker';
export class FilterIntegration {
    constructor(compositionWarehouse, filterCommandInvoker, filterWarehouse) {
        this.compositionWarehouse = compositionWarehouse;
        this.filterCommandInvoker = filterCommandInvoker;
        this.filterWarehouse = filterWarehouse;
    }
    getFilterTypes(columnName, compositionId, structureId) {
        let fieldTypes = [];
        this.compositionWarehouse
            .onTemplateColumns(compositionId)
            .pipe(hermesMap((cols) => {
            return cols.find((col) => {
                return col.getName() === columnName;
            });
        }), hermesFilter((col) => {
            return col !== undefined;
        }), hermesTake(1), hermesSwitchMap((col) => {
            return this.filterWarehouse
                .onFilterTypesForFieldId(new FieldId(col.columnFieldId.getId()), structureId);
        }))
            .subscribe((types) => {
            fieldTypes = types.map((type) => type.getName());
        });
        return fieldTypes;
    }
    filter(columnName, filterType, value, compositionId, structureId) {
        this.compositionWarehouse
            .onTemplateColumns(compositionId)
            .pipe(hermesMap((cols) => {
            return cols.find((col) => {
                return col.getName() === columnName;
            });
        }), hermesFilter((col) => {
            return col !== undefined;
        }), hermesTake(1), hermesSwitchMap((col) => {
            return this.filterWarehouse
                .onceFilterTypeId(new FieldId(col.columnFieldId.getId()), filterType, structureId)
                .pipe(hermesMap((filterTypeId) => {
                return {
                    fieldId: new FieldId(col.columnFieldId.getId()),
                    filterTypeId: filterTypeId
                };
            }));
        }))
            .subscribe((params) => {
            const { fieldId, filterTypeId } = params;
            filterTypeId.ifPresent((ftId) => {
                this.filterCommandInvoker.add(fieldId, ftId, value, structureId);
            });
        });
    }
}
FilterIntegration.decorators = [
    { type: Injectable }
];
FilterIntegration.ctorParameters = () => [
    { type: CompositionWarehouse },
    { type: FilterCommandInvoker },
    { type: FilterWarehouse }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmludGVncmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYnVpbGQtY2xpL3Byb2plY3RzL25neC1saXN0L3NyYy9zdHJ1Y3R1cmUvZmlsdGVyL2NvcmUvYXBpLWludGVncmF0aW9uL2ZpbHRlci5pbnRlZ3JhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHdEQUF3RCxDQUFDO0FBRzlGLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQVksTUFBTSxvQkFBb0IsQ0FBQztBQUNwRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFMUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXBFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBS3JFLE1BQU0sT0FBTyxpQkFBaUI7SUFFN0IsWUFBNkIsb0JBQTBDLEVBQ25ELG9CQUEwQyxFQUMxQyxlQUFnQztRQUZ2Qix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQ25ELHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQ3BELENBQUM7SUFFRCxjQUFjLENBQUMsVUFBa0IsRUFBRSxhQUE0QixFQUFFLFdBQXdCO1FBRXhGLElBQUksVUFBVSxHQUFrQixFQUFFLENBQUM7UUFFbkMsSUFBSSxDQUFDLG9CQUFvQjthQUN2QixpQkFBaUIsQ0FBQyxhQUFhLENBQUM7YUFDaEMsSUFBSSxDQUNKLFNBQVMsQ0FBQyxDQUFDLElBQTZDLEVBQUUsRUFBRTtZQUMzRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUE2QixFQUFFLEVBQUU7Z0JBQ2xELE9BQU8sR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLFVBQVUsQ0FBQztZQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxFQUNGLFlBQVksQ0FBQyxDQUFDLEdBQTZCLEVBQUUsRUFBRTtZQUM5QyxPQUFPLEdBQUcsS0FBSyxTQUFTLENBQUM7UUFDMUIsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUNiLGVBQWUsQ0FBQyxDQUFDLEdBQTZCLEVBQUUsRUFBRTtZQUNqRCxPQUFPLElBQUksQ0FBQyxlQUFlO2lCQUNyQix1QkFBdUIsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDcEYsQ0FBQyxDQUFDLENBQ0Y7YUFDQSxTQUFTLENBQUMsQ0FBQyxLQUFpQyxFQUFFLEVBQUU7WUFDaEQsVUFBVSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQyxDQUFDO1FBRUosT0FBTyxVQUFVLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sQ0FDTCxVQUFrQixFQUNsQixVQUFrQixFQUNsQixLQUFVLEVBQ1YsYUFBNEIsRUFDNUIsV0FBd0I7UUFFeEIsSUFBSSxDQUFDLG9CQUFvQjthQUN2QixpQkFBaUIsQ0FBQyxhQUFhLENBQUM7YUFDaEMsSUFBSSxDQUNKLFNBQVMsQ0FBQyxDQUFDLElBQTZDLEVBQUUsRUFBRTtZQUMzRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUE2QixFQUFFLEVBQUU7Z0JBQ2xELE9BQU8sR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLFVBQVUsQ0FBQztZQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxFQUNGLFlBQVksQ0FBQyxDQUFDLEdBQTZCLEVBQUUsRUFBRTtZQUM5QyxPQUFPLEdBQUcsS0FBSyxTQUFTLENBQUM7UUFDMUIsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUNiLGVBQWUsQ0FBQyxDQUFDLEdBQTZCLEVBQUUsRUFBRTtZQUVqRCxPQUFPLElBQUksQ0FBQyxlQUFlO2lCQUNyQixnQkFBZ0IsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLFdBQVcsQ0FBQztpQkFDakYsSUFBSSxDQUNKLFNBQVMsQ0FBQyxDQUFDLFlBQW9DLEVBQUUsRUFBRTtnQkFDbEQsT0FBTztvQkFDTixPQUFPLEVBQUUsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDL0MsWUFBWSxFQUFFLFlBQVk7aUJBQzFCLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FDRixDQUFDO1FBQ1IsQ0FBQyxDQUFDLENBQ0Y7YUFDQSxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUVyQixNQUFNLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLE1BQU0sQ0FBQztZQUV6QyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBa0IsRUFBRSxFQUFFO2dCQUM3QyxJQUFJLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUM1QixPQUFPLEVBQ1AsSUFBSSxFQUNKLEtBQUssRUFDTCxXQUFXLENBQ1gsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUFsRkQsVUFBVTs7O1lBWkYsb0JBQW9CO1lBUXBCLG9CQUFvQjtZQUpwQixlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29tcG9zaXRpb25XYXJlaG91c2UgfSBmcm9tICcuLi8uLi8uLi8uLi9jb21wb3NpdGlvbi9jb3JlL2FwaS9jb21wb3NpdGlvbi53YXJlaG91c2UnO1xuaW1wb3J0IHsgQ29tcG9zaXRpb25JZCB9IGZyb20gJy4uLy4uLy4uLy4uL2NvbXBvc2l0aW9uL2NvcmUvYXBpL2NvbXBvc2l0aW9uLmlkJztcbmltcG9ydCB7IENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3NvciB9IGZyb20gJy4uLy4uLy4uLy4uL2NvbXBvc2l0aW9uL2NvcmUvZG9tYWluLXJlYWQvZGVmaW5pdGlvbi9jZWxsLXRlbXBsYXRlLXdpdGgtYWNjZXNzb3InO1xuaW1wb3J0IHsgaGVybWVzRmlsdGVyLCBoZXJtZXNNYXAsIGhlcm1lc1N3aXRjaE1hcCwgaGVybWVzVGFrZSwgT3B0aW9uYWwgfSBmcm9tICdAZ2VuZXJpYy11aS9oZXJtZXMnO1xuaW1wb3J0IHsgRmlsdGVyV2FyZWhvdXNlIH0gZnJvbSAnLi4vYXBpL2ZpbHRlci53YXJlaG91c2UnO1xuaW1wb3J0IHsgU3RydWN0dXJlSWQgfSBmcm9tICcuLi8uLi8uLi9jb3JlL2FwaS9zdHJ1Y3R1cmUuaWQnO1xuaW1wb3J0IHsgRmllbGRJZCB9IGZyb20gJy4uLy4uLy4uL2ZpZWxkL2NvcmUvZG9tYWluL2ZpZWxkL2ZpZWxkLmlkJztcbmltcG9ydCB7IEZpbHRlclR5cGVSZWFkTW9kZWwgfSBmcm9tICcuLi9hcGkvdHlwZS9maWx0ZXItdHlwZS5yZWFkLW1vZGVsJztcbmltcG9ydCB7IEZpbHRlckNvbW1hbmRJbnZva2VyIH0gZnJvbSAnLi4vYXBpL2ZpbHRlci5jb21tYW5kLWludm9rZXInO1xuaW1wb3J0IHsgRmlsdGVyVHlwZUlkIH0gZnJvbSAnLi4vZG9tYWluL3R5cGUvZmlsdGVyLXR5cGUuaWQnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGaWx0ZXJJbnRlZ3JhdGlvbiB7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb21wb3NpdGlvbldhcmVob3VzZTogQ29tcG9zaXRpb25XYXJlaG91c2UsXG5cdFx0XHRcdHByaXZhdGUgcmVhZG9ubHkgZmlsdGVyQ29tbWFuZEludm9rZXI6IEZpbHRlckNvbW1hbmRJbnZva2VyLFxuXHRcdFx0XHRwcml2YXRlIHJlYWRvbmx5IGZpbHRlcldhcmVob3VzZTogRmlsdGVyV2FyZWhvdXNlKSB7XG5cdH1cblxuXHRnZXRGaWx0ZXJUeXBlcyhjb2x1bW5OYW1lOiBzdHJpbmcsIGNvbXBvc2l0aW9uSWQ6IENvbXBvc2l0aW9uSWQsIHN0cnVjdHVyZUlkOiBTdHJ1Y3R1cmVJZCk6IEFycmF5PHN0cmluZz4ge1xuXG5cdFx0bGV0IGZpZWxkVHlwZXM6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuXHRcdHRoaXMuY29tcG9zaXRpb25XYXJlaG91c2Vcblx0XHRcdC5vblRlbXBsYXRlQ29sdW1ucyhjb21wb3NpdGlvbklkKVxuXHRcdFx0LnBpcGUoXG5cdFx0XHRcdGhlcm1lc01hcCgoY29sczogUmVhZG9ubHlBcnJheTxDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3I+KSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIGNvbHMuZmluZCgoY29sOiBDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3IpID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiBjb2wuZ2V0TmFtZSgpID09PSBjb2x1bW5OYW1lO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KSxcblx0XHRcdFx0aGVybWVzRmlsdGVyKChjb2w6IENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3NvcikgPT4ge1xuXHRcdFx0XHRcdHJldHVybiBjb2wgIT09IHVuZGVmaW5lZDtcblx0XHRcdFx0fSksXG5cdFx0XHRcdGhlcm1lc1Rha2UoMSksXG5cdFx0XHRcdGhlcm1lc1N3aXRjaE1hcCgoY29sOiBDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3IpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5maWx0ZXJXYXJlaG91c2Vcblx0XHRcdFx0XHRcdFx0ICAgLm9uRmlsdGVyVHlwZXNGb3JGaWVsZElkKG5ldyBGaWVsZElkKGNvbC5jb2x1bW5GaWVsZElkLmdldElkKCkpLCBzdHJ1Y3R1cmVJZCk7XG5cdFx0XHRcdH0pXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKCh0eXBlczogQXJyYXk8RmlsdGVyVHlwZVJlYWRNb2RlbD4pID0+IHtcblx0XHRcdFx0ZmllbGRUeXBlcyA9IHR5cGVzLm1hcCgodHlwZSkgPT4gdHlwZS5nZXROYW1lKCkpO1xuXHRcdFx0fSk7XG5cblx0XHRyZXR1cm4gZmllbGRUeXBlcztcblx0fVxuXG5cdGZpbHRlcihcblx0XHRjb2x1bW5OYW1lOiBzdHJpbmcsXG5cdFx0ZmlsdGVyVHlwZTogc3RyaW5nLFxuXHRcdHZhbHVlOiBhbnksXG5cdFx0Y29tcG9zaXRpb25JZDogQ29tcG9zaXRpb25JZCxcblx0XHRzdHJ1Y3R1cmVJZDogU3RydWN0dXJlSWRcblx0KTogdm9pZCB7XG5cdFx0dGhpcy5jb21wb3NpdGlvbldhcmVob3VzZVxuXHRcdFx0Lm9uVGVtcGxhdGVDb2x1bW5zKGNvbXBvc2l0aW9uSWQpXG5cdFx0XHQucGlwZShcblx0XHRcdFx0aGVybWVzTWFwKChjb2xzOiBSZWFkb25seUFycmF5PENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3Nvcj4pID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gY29scy5maW5kKChjb2w6IENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3NvcikgPT4ge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGNvbC5nZXROYW1lKCkgPT09IGNvbHVtbk5hbWU7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH0pLFxuXHRcdFx0XHRoZXJtZXNGaWx0ZXIoKGNvbDogQ2VsbFRlbXBsYXRlV2l0aEFjY2Vzc29yKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIGNvbCAhPT0gdW5kZWZpbmVkO1xuXHRcdFx0XHR9KSxcblx0XHRcdFx0aGVybWVzVGFrZSgxKSxcblx0XHRcdFx0aGVybWVzU3dpdGNoTWFwKChjb2w6IENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3NvcikgPT4ge1xuXG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMuZmlsdGVyV2FyZWhvdXNlXG5cdFx0XHRcdFx0XHRcdCAgIC5vbmNlRmlsdGVyVHlwZUlkKG5ldyBGaWVsZElkKGNvbC5jb2x1bW5GaWVsZElkLmdldElkKCkpLCBmaWx0ZXJUeXBlLCBzdHJ1Y3R1cmVJZClcblx0XHRcdFx0XHRcdFx0ICAgLnBpcGUoXG5cdFx0XHRcdFx0XHRcdFx0ICAgaGVybWVzTWFwKChmaWx0ZXJUeXBlSWQ6IE9wdGlvbmFsPEZpbHRlclR5cGVJZD4pID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdCAgIHJldHVybiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdCAgIGZpZWxkSWQ6IG5ldyBGaWVsZElkKGNvbC5jb2x1bW5GaWVsZElkLmdldElkKCkpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQgICBmaWx0ZXJUeXBlSWQ6IGZpbHRlclR5cGVJZFxuXHRcdFx0XHRcdFx0XHRcdFx0ICAgfTtcblx0XHRcdFx0XHRcdFx0XHQgICB9KVxuXHRcdFx0XHRcdFx0XHQgICApO1xuXHRcdFx0XHR9KVxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgocGFyYW1zKSA9PiB7XG5cblx0XHRcdFx0Y29uc3QgeyBmaWVsZElkLCBmaWx0ZXJUeXBlSWQgfSA9IHBhcmFtcztcblxuXHRcdFx0XHRmaWx0ZXJUeXBlSWQuaWZQcmVzZW50KChmdElkOiBGaWx0ZXJUeXBlSWQpID0+IHtcblx0XHRcdFx0XHR0aGlzLmZpbHRlckNvbW1hbmRJbnZva2VyLmFkZChcblx0XHRcdFx0XHRcdGZpZWxkSWQsXG5cdFx0XHRcdFx0XHRmdElkLFxuXHRcdFx0XHRcdFx0dmFsdWUsXG5cdFx0XHRcdFx0XHRzdHJ1Y3R1cmVJZFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cdH1cblxufVxuIl19