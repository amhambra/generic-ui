import { CompositionWarehouse } from '../../../composition/api/composition.warehouse';
import { hermesFilter, hermesMap, hermesSwitchMap, hermesTake } from '@generic-ui/hermes';
import { FilterWarehouse } from '../api/filter.warehouse';
import { FieldId } from '../../field/domain/field/field.id';
import { FilterPublisher } from '../api/filter.publisher';
export class FilterIntegration {
    constructor(compositionWarehouse, filterCommandInvoker, filterWarehouse) {
        this.compositionWarehouse = compositionWarehouse;
        this.filterCommandInvoker = filterCommandInvoker;
        this.filterWarehouse = filterWarehouse;
    }
    findFilterTypes(columnName, compositionId, structureId) {
        let filterTypes = [];
        this.compositionWarehouse
            .onTemplateColumns(compositionId)
            .pipe(hermesMap((cols) => {
            return cols.find((col) => {
                return col.getName() === columnName;
            });
        }), hermesFilter((col) => {
            return col !== undefined;
        }), hermesTake(1), hermesSwitchMap((col) => {
            return this.filterWarehouse
                .onFilterTypesForFieldId(new FieldId(col.columnFieldId.getId()), structureId);
        }))
            .subscribe((types) => {
            filterTypes = types.map((type) => type.getName());
        });
        return filterTypes;
    }
    findFilters(compositionId, structureId) {
        const filters = this.filterWarehouse.findFilters(structureId).getValueOrNullOrThrowError();
        const columnNames = this.compositionWarehouse.findColumnNames(compositionId);
        const obj = {};
        for (let i = 0; i < columnNames.length; i += 1) {
            obj[columnNames[i]] = filters.filter((filter) => {
                return filter.getFieldName() === columnNames[i];
            })
                .map((filter) => {
                return {
                    columnName: filter.getFieldName(),
                    filterId: filter.getFilterId().toString(),
                    type: filter.getFilterTypeName(),
                    value: filter.getValue()
                };
            });
        }
        return obj;
    }
    filter(columnName, filterType, value, compositionId, structureId) {
        this.compositionWarehouse
            .onTemplateColumns(compositionId)
            .pipe(hermesMap((cols) => {
            return cols.find((col) => {
                return col.getName() === columnName;
            });
        }), hermesFilter((col) => {
            return col !== undefined;
        }), hermesTake(1), hermesSwitchMap((col) => {
            return this.filterWarehouse
                .onceFilterTypeId(new FieldId(col.columnFieldId.getId()), filterType, structureId)
                .pipe(hermesMap((filterTypeId) => {
                return {
                    fieldId: new FieldId(col.columnFieldId.getId()),
                    filterTypeId: filterTypeId
                };
            }));
        }))
            .subscribe((params) => {
            const { fieldId, filterTypeId } = params;
            filterTypeId.ifPresent((ftId) => {
                this.filterCommandInvoker.add(fieldId, ftId, value, structureId);
            });
        });
    }
}
FilterIntegration.services = [CompositionWarehouse, FilterPublisher, FilterWarehouse];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmludGVncmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYnVpbGQtY2xpL3Byb2plY3RzL25neC1ncmlkL3NyYy9jb3JlL3N0cnVjdHVyZS9maWx0ZXIvYXBpLWludGVncmF0aW9uL2ZpbHRlci5pbnRlZ3JhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUd0RixPQUFPLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDcEcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTFELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUU1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFNMUQsTUFBTSxPQUFPLGlCQUFpQjtJQUU3QixZQUE2QixvQkFBMEMsRUFDbkQsb0JBQXFDLEVBQ3JDLGVBQWdDO1FBRnZCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDbkQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFpQjtRQUNyQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7SUFDcEQsQ0FBQztJQUlELGVBQWUsQ0FBQyxVQUFrQixFQUFFLGFBQTRCLEVBQUUsV0FBd0I7UUFFekYsSUFBSSxXQUFXLEdBQWtCLEVBQUUsQ0FBQztRQUVwQyxJQUFJLENBQUMsb0JBQW9CO2FBQ3ZCLGlCQUFpQixDQUFDLGFBQWEsQ0FBQzthQUNoQyxJQUFJLENBQ0osU0FBUyxDQUFDLENBQUMsSUFBNkMsRUFBRSxFQUFFO1lBQzNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQTZCLEVBQUUsRUFBRTtnQkFDbEQsT0FBTyxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssVUFBVSxDQUFDO1lBQ3JD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QUNqRixJQUFJLENBQ0osU0FBUyxDQUFDLENBQUMsWUFBb0MsRUFBRSxFQUFFO2dCQUNsRCxPQUFPO29CQUNOLE9BQU8sRUFBRSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUMvQyxZQUFZLEVBQUUsWUFBWTtpQkFDMUIsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUNGLENBQUM7UUFDUixDQUFDLENBQUMsQ0FDRjthQUNBLFNBQVMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBRXJCLE1BQU0sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLEdBQUcsTUFBTSxDQUFDO1lBRXpDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFrQixFQUFFLEVBQUU7Z0JBQzdDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQzVCLE9BQU8sRUFDUCxJQUFJLEVBQ0osS0FBSyxFQUNMLFdBQVcsQ0FDWCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7O0FBdEdlLDBCQUFRLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxlQUFlLEVBQUUsZUFBZSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NpdGlvbldhcmVob3VzZSB9IGZyb20gJy4uLy4uLy4uL2NvbXBvc2l0aW9uL2FwaS9jb21wb3NpdGlvbi53YXJlaG91c2UnO1xuaW1wb3J0IHsgQ29tcG9zaXRpb25JZCB9IGZyb20gJy4uLy4uLy4uL2NvbXBvc2l0aW9uL2FwaS9nbG9iYWwvY29tcG9zaXRpb24uaWQnO1xuaW1wb3J0IHsgQ2VsbFRlbXBsYXRlV2l0aEFjY2Vzc29yIH0gZnJvbSAnLi4vLi4vLi4vY29tcG9zaXRpb24vY29yZS1yZWFkL2RlZmluaXRpb24vY2VsbC10ZW1wbGF0ZS13aXRoLWFjY2Vzc29yJztcbmltcG9ydCB7IGhlcm1lc0ZpbHRlciwgaGVybWVzTWFwLCBoZXJtZXNTd2l0Y2hNYXAsIGhlcm1lc1Rha2UsIE9wdGlvbmFsIH0gZnJvbSAnQGdlbmVyaWMtdWkvaGVybWVzJztcbmltcG9ydCB7IEZpbHRlcldhcmVob3VzZSB9IGZyb20gJy4uL2FwaS9maWx0ZXIud2FyZWhvdXNlJztcbmltcG9ydCB7IFN0cnVjdHVyZUlkIH0gZnJvbSAnLi4vLi4vc3RydWN0dXJlLWNvcmUvYXBpL2dsb2JhbC9zdHJ1Y3R1cmUuaWQnO1xuaW1wb3J0IHsgRmllbGRJZCB9IGZyb20gJy4uLy4uL2ZpZWxkL2RvbWFpbi9maWVsZC9maWVsZC5pZCc7XG5pbXBvcnQgeyBGaWx0ZXJUeXBlTW9kZWwgfSBmcm9tICcuLi9hcGkvdHlwZS9maWx0ZXItdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBGaWx0ZXJQdWJsaXNoZXIgfSBmcm9tICcuLi9hcGkvZmlsdGVyLnB1Ymxpc2hlcic7XG5pbXBvcnQgeyBGaWx0ZXJUeXBlSWQgfSBmcm9tICcuLi9kb21haW4vdHlwZS9maWx0ZXItdHlwZS5pZCc7XG5pbXBvcnQgeyBBY3RpdmVGaWx0ZXJNb2RlbCB9IGZyb20gJy4uL2FwaS9hY3RpdmUvYWN0aXZlLWZpbHRlci5tb2RlbCc7XG5pbXBvcnQgeyBGaWx0ZXJGb3JDb2x1bW4gfSBmcm9tICcuL2ZpbHRlci1pbnRlZ3JhdGlvbi5hcGknO1xuXG5cbmV4cG9ydCBjbGFzcyBGaWx0ZXJJbnRlZ3JhdGlvbiB7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBjb21wb3NpdGlvbldhcmVob3VzZTogQ29tcG9zaXRpb25XYXJlaG91c2UsXG5cdFx0XHRcdHByaXZhdGUgcmVhZG9ubHkgZmlsdGVyQ29tbWFuZEludm9rZXI6IEZpbHRlclB1Ymxpc2hlcixcblx0XHRcdFx0cHJpdmF0ZSByZWFkb25seSBmaWx0ZXJXYXJlaG91c2U6IEZpbHRlcldhcmVob3VzZSkge1xuXHR9XG5cblx0c3RhdGljIHJlYWRvbmx5IHNlcnZpY2VzID0gW0NvbXBvc2l0aW9uV2FyZWhvdXNlLCBGaWx0ZXJQdWJsaXNoZXIsIEZpbHRlcldhcmVob3VzZV07XG5cblx0ZmluZEZpbHRlclR5cGVzKGNvbHVtbk5hbWU6IHN0cmluZywgY29tcG9zaXRpb25JZDogQ29tcG9zaXRpb25JZCwgc3RydWN0dXJlSWQ6IFN0cnVjdHVyZUlkKTogQXJyYXk8c3RyaW5nPiB7XG5cblx0XHRsZXQgZmlsdGVyVHlwZXM6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuXHRcdHRoaXMuY29tcG9zaXRpb25XYXJlaG91c2Vcblx0XHRcdC5vblRlbXBsYXRlQ29sdW1ucyhjb21wb3NpdGlvbklkKVxuXHRcdFx0LnBpcGUoXG5cdFx0XHRcdGhlcm1lc01hcCgoY29sczogUmVhZG9ubHlBcnJheTxDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3I+KSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIGNvbHMuZmluZCgoY29sOiBDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3IpID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiBjb2wuZ2V0TmFtZSgpID09PSBjb2x1bW5OYW1lO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KSxcblx0XHRcdFx0aGVybWVzRmlsdGVyKChjb2w6IENlbGxUZW1wbGF0ZVdpdGhBY2Nlc3NvcikgPT4ge1xuXHRcdFx0XHRcdHJldHVybiBjb2wgIT09IHVuZGVmaW5lZDtcblx0XHRcdFx0fSksXG5cdFx0XHRcdGhlcm1lc1Rha2UoMSksXG5cdFx0XHRcdGhlcm1lc1N3aXRjaE1hcCgoY29sOiBDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3IpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5maWx0ZXJXYXJlaG91c2Vcblx0XHRcdFx0XHRcdFx0ICAgLm9uRmlsdGVyVHlwZXNGb3JGaWVsZElkKG5ldyBGaWVsZElkKGNvbC5jb2x1bW5GaWVsZElkLmdldElkKCkpLCBzdHJ1Y3R1cmVJZCk7XG5cdFx0XHRcdH0pXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKCh0eXBlczogQXJyYXk8RmlsdGVyVHlwZU1vZGVsPikgPT4ge1xuXHRcdFx0XHRmaWx0ZXJUeXBlcyA9IHR5cGVzLm1hcCgodHlwZSkgPT4gdHlwZS5nZXROYW1lKCkpO1xuXHRcdFx0fSk7XG5cblx0XHRyZXR1cm4gZmlsdGVyVHlwZXM7XG5cdH1cblxuXHRmaW5kRmlsdGVycyhjb21wb3NpdGlvbklkOiBDb21wb3NpdGlvbklkLCBzdHJ1Y3R1cmVJZDogU3RydWN0dXJlSWQpOiB7IFtrZXk6IHN0cmluZ106IFJlYWRvbmx5QXJyYXk8RmlsdGVyRm9yQ29sdW1uPiB9IHtcblxuXHRcdGNvbnN0IGZpbHRlcnMgPSB0aGlzLmZpbHRlcldhcmVob3VzZS5maW5kRmlsdGVycyhzdHJ1Y3R1cmVJZCkuZ2V0VmFsdWVPck51bGxPclRocm93RXJyb3IoKTtcblxuXHRcdGNvbnN0IGNvbHVtbk5hbWVzID0gdGhpcy5jb21wb3NpdGlvbldhcmVob3VzZS5maW5kQ29sdW1uTmFtZXMoY29tcG9zaXRpb25JZCk7XG5cblx0XHRjb25zdCBvYmogPSB7fTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgY29sdW1uTmFtZXMubGVuZ3RoOyBpICs9IDEpIHtcblx0XHRcdG9ialtjb2x1bW5OYW1lc1tpXV0gPSBmaWx0ZXJzLmZpbHRlcigoZmlsdGVyOiBBY3RpdmVGaWx0ZXJNb2RlbCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCByZXR1cm4gZmlsdGVyLmdldEZpZWxkTmFtZSgpID09PSBjb2x1bW5OYW1lc1tpXTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0IH0pXG5cdFx0XHRcdFx0XHRcdFx0XHRcdCAubWFwKChmaWx0ZXI6IEFjdGl2ZUZpbHRlck1vZGVsKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0IHJldHVybiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQgY29sdW1uTmFtZTogZmlsdGVyLmdldEZpZWxkTmFtZSgpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0IGZpbHRlcklkOiBmaWx0ZXIuZ2V0RmlsdGVySWQoKS50b1N0cmluZygpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0IHR5cGU6IGZpbHRlci5nZXRGaWx0ZXJUeXBlTmFtZSgpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0IHZhbHVlOiBmaWx0ZXIuZ2V0VmFsdWUoKVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCB9O1xuXHRcdFx0XHRcdFx0XHRcdFx0XHQgfSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG9iajtcblx0fVxuXG5cdGZpbHRlcihcblx0XHRjb2x1bW5OYW1lOiBzdHJpbmcsXG5cdFx0ZmlsdGVyVHlwZTogc3RyaW5nLFxuXHRcdHZhbHVlOiBhbnksXG5cdFx0Y29tcG9zaXRpb25JZDogQ29tcG9zaXRpb25JZCxcblx0XHRzdHJ1Y3R1cmVJZDogU3RydWN0dXJlSWRcblx0KTogdm9pZCB7XG5cblx0XHR0aGlzLmNvbXBvc2l0aW9uV2FyZWhvdXNlXG5cdFx0XHQub25UZW1wbGF0ZUNvbHVtbnMoY29tcG9zaXRpb25JZClcblx0XHRcdC5waXBlKFxuXHRcdFx0XHRoZXJtZXNNYXAoKGNvbHM6IFJlYWRvbmx5QXJyYXk8Q2VsbFRlbXBsYXRlV2l0aEFjY2Vzc29yPikgPT4ge1xuXHRcdFx0XHRcdHJldHVybiBjb2xzLmZpbmQoKGNvbDogQ2VsbFRlbXBsYXRlV2l0aEFjY2Vzc29yKSA9PiB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gY29sLmdldE5hbWUoKSA9PT0gY29sdW1uTmFtZTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSksXG5cdFx0XHRcdGhlcm1lc0ZpbHRlcigoY29sOiBDZWxsVGVtcGxhdGVXaXRoQWNjZXNzb3IpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gY29sICE9PSB1bmRlZmluZWQ7XG5cdFx0XHRcdH0pLFxuXHRcdFx0XHRoZXJtZXNUYWtlKDEpLFxuXHRcdFx0XHRoZXJtZXNTd2l0Y2hNYXAoKGNvbDogQ2VsbFRlbXBsYXRlV2l0aEFjY2Vzc29yKSA9PiB7XG5cblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5maWx0ZXJXYXJlaG91c2Vcblx0XHRcdFx0XHRcdFx0ICAgLm9uY2VGaWx0ZXJUeXBlSWQobmV3IEZpZWxkSWQoY29sLmNvbHVtbkZpZWxkSWQuZ2V0SWQoKSksIGZpbHRlclR5cGUsIHN0cnVjdHVyZUlkKVxuXHRcdFx0XHRcdFx0XHQgICAucGlwZShcblx0XHRcdFx0XHRcdFx0XHQgICBoZXJtZXNNYXAoKGZpbHRlclR5cGVJZDogT3B0aW9uYWw8RmlsdGVyVHlwZUlkPikgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0ICAgcmV0dXJuIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0ICAgZmllbGRJZDogbmV3IEZpZWxkSWQoY29sLmNvbHVtbkZpZWxkSWQuZ2V0SWQoKSksXG5cdFx0XHRcdFx0XHRcdFx0XHRcdCAgIGZpbHRlclR5cGVJZDogZmlsdGVyVHlwZUlkXG5cdFx0XHRcdFx0XHRcdFx0XHQgICB9O1xuXHRcdFx0XHRcdFx0XHRcdCAgIH0pXG5cdFx0XHRcdFx0XHRcdCAgICk7XG5cdFx0XHRcdH0pXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKChwYXJhbXMpID0+IHtcblxuXHRcdFx0XHRjb25zdCB7IGZpZWxkSWQsIGZpbHRlclR5cGVJZCB9ID0gcGFyYW1zO1xuXG5cdFx0XHRcdGZpbHRlclR5cGVJZC5pZlByZXNlbnQoKGZ0SWQ6IEZpbHRlclR5cGVJZCkgPT4ge1xuXHRcdFx0XHRcdHRoaXMuZmlsdGVyQ29tbWFuZEludm9rZXIuYWRkKFxuXHRcdFx0XHRcdFx0ZmllbGRJZCxcblx0XHRcdFx0XHRcdGZ0SWQsXG5cdFx0XHRcdFx0XHR2YWx1ZSxcblx0XHRcdFx0XHRcdHN0cnVjdHVyZUlkXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblx0fVxuXG59XG4iXX0=