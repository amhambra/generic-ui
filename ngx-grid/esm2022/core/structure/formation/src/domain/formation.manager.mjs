import { RowSelectToggleType } from './row-select-toggle-type';
import { RowSelectionMode, RowSelectionType } from '../api/row-selected/row-selection';
import { FormationSelection } from './selection/formation.selection';
import { SelectionModeSetAggregateEvent } from '../core/mode/selection-mode-set.aggregate-event';
import { SelectionTypeSetAggregateEvent } from '../core/type/selection-type-set.aggregate-event';
import { SelectionEnabledSetAggregateEvent } from '../core/set-enabled/selection-enabled-set.aggregate-event';
import { ItemEntityId } from '../../../source/src/domain/item/item.entity-id';
import { FormationCustomSelectId } from '../api/custom/formation.custom-select.id';
import { FormationCustomManager } from './custom/formation.custom.manager';
import { FormationCustomSelectionChangeAggregateEvent } from '../core/custom/formation.custom-selection-change.aggregate-event';
import { FormationCustomSelection, FormationCustomSelectionFunctionModel } from '../api/custom/formation.custom-selection';
export class FormationManager {
    id;
    selectedItemIds;
    enabled;
    selection = new FormationSelection(RowSelectionMode.SINGLE, RowSelectionType.ROW);
    allSelected;
    allUnselected;
    customSelection;
    matcher = (item) => item.id;
    constructor(id, selectedItemIds) {
        this.id = id;
        this.selectedItemIds = selectedItemIds;
    }
    init(enabled, mode, type) {
        this.enabled = enabled;
        this.selection.setMode(mode);
        this.selection.setType(type);
        this.customSelection = new FormationCustomManager(false, [
            new FormationCustomSelectionFunctionModel('select_all', 'SELECT_ALL', new FormationCustomSelectId('SELECT_ALL'), true),
            new FormationCustomSelectionFunctionModel('UNSELECT_ALL', 'UNSELECT_ALL', new FormationCustomSelectId('UNSELECT_ALL'), true),
            new FormationCustomSelectionFunctionModel('', 'INVERT', new FormationCustomSelectId('INVERT'), true)
        ]);
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled),
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType()),
            new FormationCustomSelectionChangeAggregateEvent(this.getId(), new FormationCustomSelection(this.customSelection.isEnabled(), this.customSelection.getSelections()))
        ];
    }
    setSelection(enabled) {
        this.enabled = enabled;
        return [
            new SelectionEnabledSetAggregateEvent(this.getId(), this.enabled)
        ];
    }
    setMode(mode) {
        this.selection.setMode(mode);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setType(type) {
        this.selection.setType(type);
        return [
            new SelectionModeSetAggregateEvent(this.getId(), this.selection.getMode()),
            new SelectionTypeSetAggregateEvent(this.getId(), this.selection.getType())
        ];
    }
    setMatcher(matcher) {
        this.matcher = matcher;
    }
    setCustomConfig(config) {
        if (config?.enabled) {
            this.customSelection.setEnabled(config.enabled);
        }
        if (config?.selections) {
            this.customSelection.setSelections(config.selections);
        }
        return [
            new FormationCustomSelectionChangeAggregateEvent(this.getId(), new FormationCustomSelection(this.customSelection.isEnabled(), this.customSelection.getSelections()))
        ];
    }
    isAllSelected() {
        return this.allSelected;
    }
    isAllUnselected() {
        return this.allUnselected;
    }
    getSelectedItemIds() {
        return Array.from(this.selectedItemIds).map(id => new ItemEntityId(id));
    }
    selectCustom(id, itemEntities) {
        this.customSelection
            .findSelection(id)
            .ifPresent((s) => {
            if (s.isBuiltIn()) {
                switch (s.getCustomSelectId().toString()) {
                    case 'SELECT_ALL':
                        this.selectAll(itemEntities.map(i => i.getId()));
                        break;
                    case 'UNSELECT_ALL':
                        this.unselectAll();
                        break;
                    case 'INVERT':
                        this.invertSelected(itemEntities.map(i => i.getId()));
                        break;
                    default:
                        break;
                }
            }
            else {
                const selectedItems = s.customSelect(itemEntities);
                this.selectedItemIds = new Set(selectedItems.map(item => item.getId().toString()));
            }
        });
    }
    selectAll(allEntityIds) {
        this.selectedItemIds = new Set(allEntityIds.map(id => id.toString()));
        this.allSelected = true;
        this.allUnselected = false;
    }
    unselectAll() {
        this.selectedItemIds.clear();
        this.allSelected = false;
        this.allUnselected = true;
    }
    invertSelected(allEntityIds) {
        const selectedItemIds = this.getSelectedItemIds();
        const a = allEntityIds.filter((id) => {
            return !selectedItemIds.some((selId) => selId.equals(id));
        });
        this.selectedItemIds = new Set(a.map(id => id.toString()));
        this.calculateAllSelected(allEntityIds);
        this.calculateAllUnselected();
    }
    reSelectByIds(itemEntities) {
        this.selectByIds(this.getSelectedItemIds().map(i => i.getId()), itemEntities);
        this.calculateAllSelected(itemEntities.map(i => i.getId()));
        this.calculateAllUnselected();
    }
    selectByIds(ids, itemEntities) {
        if (!this.enabled) {
            return;
        }
        const itemIds = [];
        for (let i = 0; i < ids.length; i++) {
            const items = itemEntities
                .filter((item) => {
                return this.matcher(item.getSourceItem()) === ids[i];
            })
                .map((item) => item.getId().toString());
            itemIds.push(...items);
        }
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(itemEntities.map(i => i.getId()));
        this.calculateAllUnselected();
    }
    selectByIndex(indexes, allEntityIds) {
        if (!this.enabled) {
            return;
        }
        const itemIds = indexes.map((i) => {
            if (!allEntityIds[i]) {
                console.error('Item not found');
            }
            return allEntityIds[i].toString();
        });
        let type = RowSelectToggleType.ADD;
        if (this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        itemIds.forEach((id) => {
            this.toggleRowByType(type, id);
        });
        this.calculateAllSelected(allEntityIds);
        this.calculateAllUnselected();
    }
    selectRows(itemIds, itemEntityIds) {
    }
    toggleRow(itemId, type, itemEntityIds) {
        if (!this.enabled) {
            return;
        }
        if (type === RowSelectToggleType.ADD && this.selection.isSingle()) {
            type = RowSelectToggleType.NONE;
        }
        this.toggleRowByType(type, itemId);
        this.calculateAllSelected(itemEntityIds);
        this.calculateAllUnselected();
    }
    calculateAllSelected(itemEntityIds) {
        if (itemEntityIds.length !== this.selectedItemIds.size) {
            this.allSelected = false;
        }
        else {
            const rows = Array.from(this.selectedItemIds);
            let equal = true;
            rows.sort();
            itemEntityIds.sort();
            for (let i = 0; i < rows.length; i += 1) {
                if (rows[i] !== itemEntityIds[i].toString()) {
                    equal = false;
                    break;
                }
            }
            this.allSelected = equal;
        }
    }
    calculateAllUnselected() {
        this.allUnselected = this.selectedItemIds.size === 0;
    }
    unselectRow(itemEntityId) {
        if (this.selectedItemIds.has(itemEntityId.toString())) {
            this.selectedItemIds.delete(itemEntityId.toString());
        }
    }
    getId() {
        return this.id;
    }
    getType() {
        return this.selection.getType();
    }
    toggleRowByType(type, itemId) {
        switch (type) {
            case RowSelectToggleType.NONE:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.clear();
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.ADD:
                if (this.selectedItemIds.has(itemId)) {
                    this.selectedItemIds.delete(itemId);
                }
                else {
                    this.selectedItemIds.add(itemId);
                }
                break;
            case RowSelectToggleType.RANGE:
                break;
            default:
                break;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0aW9uLm1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9idWlsZC1jbGkvcHJvamVjdHMvbmd4LWdyaWQvc3JjL2NvcmUvc3RydWN0dXJlL2Zvcm1hdGlvbi9zcmMvZG9tYWluL2Zvcm1hdGlvbi5tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRXJFLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRWpHLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxNQUFNLDJEQUEyRCxDQUFDO0FBQzlHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnREFBZ0QsQ0FBQztBQUU5RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNuRixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMzRSxPQUFPLEVBQUUsNENBQTRDLEVBQUUsTUFBTSxrRUFBa0UsQ0FBQztBQUNoSSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUscUNBQXFDLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUczSCxNQUFNLE9BQU8sZ0JBQWdCO0lBY1I7SUFDVDtJQWJILE9BQU8sQ0FBVTtJQUVqQixTQUFTLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFbEYsV0FBVyxDQUFVO0lBRXJCLGFBQWEsQ0FBVTtJQUV2QixlQUFlLENBQXlC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QUNqQyxDQUFDO0lBRU8sZUFBZSxDQUFDLElBQXlCLEVBQUUsTUFBYztRQUVoRSxRQUFRLElBQUksRUFBRTtZQUNiLEtBQUssbUJBQW1CLENBQUMsSUFBSTtnQkFFNUIsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDckMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ3BDO3FCQUFNO29CQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNqQztnQkFFRCxNQUFNO1lBRVAsS0FBSyxtQkFBbUIsQ0FBQyxHQUFHO2dCQUUzQixJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUNyQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDcEM7cUJBQU07b0JBQ04sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2pDO2dCQUVELE1BQU07WUFFUCxLQUFLLG1CQUFtQixDQUFDLEtBQUs7Z0JBRTdCLE1BQU07WUFFUDtnQkFDQyxNQUFNO1NBQ1A7SUFDRixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSb3dTZWxlY3RUb2dnbGVUeXBlIH0gZnJvbSAnLi9yb3ctc2VsZWN0LXRvZ2dsZS10eXBlJztcbmltcG9ydCB7IFJvd1NlbGVjdGlvbk1vZGUsIFJvd1NlbGVjdGlvblR5cGUgfSBmcm9tICcuLi9hcGkvcm93LXNlbGVjdGVkL3Jvdy1zZWxlY3Rpb24nO1xuaW1wb3J0IHsgRm9ybWF0aW9uU2VsZWN0aW9uIH0gZnJvbSAnLi9zZWxlY3Rpb24vZm9ybWF0aW9uLnNlbGVjdGlvbic7XG5pbXBvcnQgeyBTdHJ1Y3R1cmVBZ2dyZWdhdGVFdmVudCB9IGZyb20gJy4uLy4uLy4uL3N0cnVjdHVyZS1jb3JlL3NyYy9jb3JlL3N0cnVjdHVyZS5hZ2dyZWdhdGUtZXZlbnQnO1xuaW1wb3J0IHsgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50IH0gZnJvbSAnLi4vY29yZS9tb2RlL3NlbGVjdGlvbi1tb2RlLXNldC5hZ2dyZWdhdGUtZXZlbnQnO1xuaW1wb3J0IHsgU3RydWN0dXJlSWQgfSBmcm9tICcuLi8uLi8uLi9zdHJ1Y3R1cmUtY29yZS9zcmMvYXBpL2dsb2JhbC9zdHJ1Y3R1cmUuaWQnO1xuaW1wb3J0IHsgU2VsZWN0aW9uVHlwZVNldEFnZ3JlZ2F0ZUV2ZW50IH0gZnJvbSAnLi4vY29yZS90eXBlL3NlbGVjdGlvbi10eXBlLXNldC5hZ2dyZWdhdGUtZXZlbnQnO1xuaW1wb3J0IHsgU2VsZWN0aW9uRW5hYmxlZFNldEFnZ3JlZ2F0ZUV2ZW50IH0gZnJvbSAnLi4vY29yZS9zZXQtZW5hYmxlZC9zZWxlY3Rpb24tZW5hYmxlZC1zZXQuYWdncmVnYXRlLWV2ZW50JztcbmltcG9ydCB7IEl0ZW1FbnRpdHlJZCB9IGZyb20gJy4uLy4uLy4uL3NvdXJjZS9zcmMvZG9tYWluL2l0ZW0vaXRlbS5lbnRpdHktaWQnO1xuaW1wb3J0IHsgSXRlbUVudGl0eSB9IGZyb20gJy4uLy4uLy4uL3NvdXJjZS9zcmMvZG9tYWluL2l0ZW0vaXRlbS5lbnRpdHknO1xuaW1wb3J0IHsgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0SWQgfSBmcm9tICcuLi9hcGkvY3VzdG9tL2Zvcm1hdGlvbi5jdXN0b20tc2VsZWN0LmlkJztcbmltcG9ydCB7IEZvcm1hdGlvbkN1c3RvbU1hbmFnZXIgfSBmcm9tICcuL2N1c3RvbS9mb3JtYXRpb24uY3VzdG9tLm1hbmFnZXInO1xuaW1wb3J0IHsgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uQ2hhbmdlQWdncmVnYXRlRXZlbnQgfSBmcm9tICcuLi9jb3JlL2N1c3RvbS9mb3JtYXRpb24uY3VzdG9tLXNlbGVjdGlvbi1jaGFuZ2UuYWdncmVnYXRlLWV2ZW50JztcbmltcG9ydCB7IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbiwgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uRnVuY3Rpb25Nb2RlbCB9IGZyb20gJy4uL2FwaS9jdXN0b20vZm9ybWF0aW9uLmN1c3RvbS1zZWxlY3Rpb24nO1xuaW1wb3J0IHsgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uQ29uZmlnIH0gZnJvbSAnLi4vYXBpL2N1c3RvbS9mb3JtYXRpb24uY3VzdG9tLXNlbGVjdGlvbi5jb25maWcnO1xuXG5leHBvcnQgY2xhc3MgRm9ybWF0aW9uTWFuYWdlciB7XG5cblx0cHJpdmF0ZSBlbmFibGVkOiBib29sZWFuO1xuXG5cdHByaXZhdGUgc2VsZWN0aW9uID0gbmV3IEZvcm1hdGlvblNlbGVjdGlvbihSb3dTZWxlY3Rpb25Nb2RlLlNJTkdMRSwgUm93U2VsZWN0aW9uVHlwZS5ST1cpO1xuXG5cdHByaXZhdGUgYWxsU2VsZWN0ZWQ6IGJvb2xlYW47XG5cblx0cHJpdmF0ZSBhbGxVbnNlbGVjdGVkOiBib29sZWFuO1xuXG5cdHByaXZhdGUgY3VzdG9tU2VsZWN0aW9uOiBGb3JtYXRpb25DdXN0b21NYW5hZ2VyO1xuXG5cdHByaXZhdGUgbWF0Y2hlcjogKGl0ZW06IGFueSkgPT4gYW55ID0gKGl0ZW06IGFueSkgPT4gaXRlbS5pZDtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIGlkOiBTdHJ1Y3R1cmVJZCxcblx0XHRcdFx0cHJpdmF0ZSBzZWxlY3RlZEl0ZW1JZHM6IFNldDxzdHJpbmc+KSB7XG5cdH1cblxuXHRpbml0KGVuYWJsZWQ6IGJvb2xlYW4sIG1vZGU6IFJvd1NlbGVjdGlvbk1vZGUsIHR5cGU6IFJvd1NlbGVjdGlvblR5cGUpOiBBcnJheTxTdHJ1Y3R1cmVBZ2dyZWdhdGVFdmVudD4ge1xuXHRcdHRoaXMuZW5hYmxlZCA9IGVuYWJsZWQ7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0TW9kZShtb2RlKTtcblx0XHR0aGlzLnNlbGVjdGlvbi5zZXRUeXBlKHR5cGUpO1xuXHRcdHRoaXMuY3VzdG9tU2VsZWN0aW9uID0gbmV3IEZvcm1hdGlvbkN1c3RvbU1hbmFnZXIoZmFsc2UsIFtcblx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb25GdW5jdGlvbk1vZGVsKFxuXHRcdFx0XHQnc2VsZWN0X2FsbCcsXG5cdFx0XHRcdCdTRUxFQ1RfQUxMJyxcblx0XHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdElkKCdTRUxFQ1RfQUxMJyksXG5cdFx0XHRcdHRydWVcblx0XHRcdCksXG5cdFx0XHRuZXcgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0aW9uRnVuY3Rpb25Nb2RlbChcblx0XHRcdFx0J1VOU0VMRUNUX0FMTCcsXG5cdFx0XHRcdCdVTlNFTEVDVF9BTEwnLFxuXHRcdFx0XHRuZXcgRm9ybWF0aW9uQ3VzdG9tU2VsZWN0SWQoJ1VOU0VMRUNUX0FMTCcpLFxuXHRcdFx0XHR0cnVlXG5cdFx0XHQpLFxuXHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkZ1bmN0aW9uTW9kZWwoXG5cdFx0XHRcdCcnLFxuXHRcdFx0XHQnSU5WRVJUJyxcblx0XHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdElkKCdJTlZFUlQnKSxcblx0XHRcdFx0dHJ1ZVxuXHRcdFx0KVxuXHRcdF0pO1xuXG5cdFx0cmV0dXJuIFtcblx0XHRcdG5ldyBTZWxlY3Rpb25FbmFibGVkU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLmVuYWJsZWQpLFxuXHRcdFx0bmV3IFNlbGVjdGlvbk1vZGVTZXRBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIHRoaXMuc2VsZWN0aW9uLmdldE1vZGUoKSksXG5cdFx0XHRuZXcgU2VsZWN0aW9uVHlwZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0VHlwZSgpKSxcblx0XHRcdG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb25DaGFuZ2VBZ2dyZWdhdGVFdmVudCh0aGlzLmdldElkKCksIG5ldyBGb3JtYXRpb25DdXN0b21TZWxlY3Rpb24odGhpcy5jdXN0b21TZWxlY3Rpb24uaXNFbmFibGVkKCksIHRoaXMuY3VzdG9tU2VsZWN0aW9uLmdldFNlbGVjdGlvbnMoKSkpXG5cdFx0XTtcblx0fVxuXG5cdHNldFNlbGVjdGlvbihlbmFibGVkOiBib29sZWFuKTogQXJyYXk8U3RydWN0dXJlQWdncmVnYXRlRXZlbnQ+IHtcblx0XHR0aGlzLmVuYWJsZWQgPSBlbmFibGVkO1xuXG5cdFx0cmV0dXJuIFtcblx0XHRcdG5ldyBTZWxlY3Rpb25FbmFibGVkU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLmVuYWJsZWQpXG5cdFx0XTtcblx0fVxuXG5cdHNldE1vZGUobW9kZTogUm93U2VsZWN0aW9uTW9kZSk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0TW9kZShtb2RlKTtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0TW9kZSgpKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCkpXG5cdFx0XTtcblx0fVxuXG5cdHNldFR5cGUodHlwZTogUm93U2VsZWN0aW9uVHlwZSk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cdFx0dGhpcy5zZWxlY3Rpb24uc2V0VHlwZSh0eXBlKTtcblxuXHRcdHJldHVybiBbXG5cdFx0XHRuZXcgU2VsZWN0aW9uTW9kZVNldEFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgdGhpcy5zZWxlY3Rpb24uZ2V0TW9kZSgpKSxcblx0XHRcdG5ldyBTZWxlY3Rpb25UeXBlU2V0QWdncmVnYXRlRXZlbnQodGhpcy5nZXRJZCgpLCB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCkpXG5cdFx0XTtcblx0fVxuXG5cdHNldE1hdGNoZXIobWF0Y2hlcjogKGl0ZW06IGFueSkgPT4gYW55KTogdm9pZCB7XG5cdFx0dGhpcy5tYXRjaGVyID0gbWF0Y2hlcjtcblx0fVxuXG5cdHNldEN1c3RvbUNvbmZpZyhjb25maWc6IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkNvbmZpZyk6IEFycmF5PFN0cnVjdHVyZUFnZ3JlZ2F0ZUV2ZW50PiB7XG5cblx0XHRpZiAoY29uZmlnPy5lbmFibGVkKSB7XG5cdFx0XHR0aGlzLmN1c3RvbVNlbGVjdGlvbi5zZXRFbmFibGVkKGNvbmZpZy5lbmFibGVkKTtcblx0XHR9XG5cblx0XHRpZiAoY29uZmlnPy5zZWxlY3Rpb25zKSB7XG5cdFx0XHR0aGlzLmN1c3RvbVNlbGVjdGlvbi5zZXRTZWxlY3Rpb25zKGNvbmZpZy5zZWxlY3Rpb25zKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0bmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbkNoYW5nZUFnZ3JlZ2F0ZUV2ZW50KHRoaXMuZ2V0SWQoKSwgbmV3IEZvcm1hdGlvbkN1c3RvbVNlbGVjdGlvbih0aGlzLmN1c3RvbVNlbGVjdGlvbi5pc0VuYWJsZWQoKSwgdGhpcy5jdXN0b21TZWxlY3Rpb24uZ2V0U2VsZWN0aW9ucygpKSlcblx0XHRdO1xuXHR9XG5cblx0aXNBbGxTZWxlY3RlZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5hbGxTZWxlY3RlZDtcblx0fVxuXG5cdGlzQWxsVW5zZWxlY3RlZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5hbGxVbnNlbGVjdGVkO1xuXHR9XG5cblx0Z2V0U2VsZWN0ZWRJdGVtSWRzKCk6IEFycmF5PEl0ZW1FbnRpdHlJZD4ge1xuXHRcdHJldHVybiBBcnJheS5mcm9tKHRoaXMuc2VsZWN0ZWRJdGVtSWRzKS5tYXAoaWQgPT4gbmV3IEl0ZW1FbnRpdHlJZChpZCkpO1xuXHR9XG5cblx0c2VsZWN0Q3VzdG9tKGlkOiBGb3JtYXRpb25DdXN0b21TZWxlY3RJZCwgaXRlbUVudGl0aWVzOiBBcnJheTxJdGVtRW50aXR5Pik6IHZvaWQge1xuXG5cdFx0dGhpcy5jdXN0b21TZWxlY3Rpb25cblx0XHRcdC5maW5kU2VsZWN0aW9uKGlkKVxuXHRcdFx0LmlmUHJlc2VudCgocykgPT4ge1xuXHRcdFx0XHRpZiAocy5pc0J1aWx0SW4oKSkge1xuXG5cdFx0XHRcdFx0c3dpdGNoIChzLmdldEN1c3RvbVNlbGVjdElkKCkudG9TdHJpbmcoKSkge1xuXHRcdFx0XHRcdFx0Y2FzZSAnU0VMRUNUX0FMTCc6XG5cdFx0XHRcdFx0XHRcdHRoaXMuc2VsZWN0QWxsKGl0ZW1FbnRpdGllcy5tYXAoaSA9PiBpLmdldElkKCkpKTtcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdFx0XHRcdGNhc2UgJ1VOU0VMRUNUX0FMTCc6XG5cdFx0XHRcdFx0XHRcdHRoaXMudW5zZWxlY3RBbGwoKTtcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdFx0XHRcdGNhc2UgJ0lOVkVSVCc6XG5cdFx0XHRcdFx0XHRcdHRoaXMuaW52ZXJ0U2VsZWN0ZWQoaXRlbUVudGl0aWVzLm1hcChpID0+IGkuZ2V0SWQoKSkpO1xuXHRcdFx0XHRcdFx0XHRicmVhaztcblxuXHRcdFx0XHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdH0gZWxzZSB7XG5cblx0XHRcdFx0XHRjb25zdCBzZWxlY3RlZEl0ZW1zID0gcy5jdXN0b21TZWxlY3QoaXRlbUVudGl0aWVzKTtcblxuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzID0gbmV3IFNldDxzdHJpbmc+KHNlbGVjdGVkSXRlbXMubWFwKGl0ZW0gPT4gaXRlbS5nZXRJZCgpLnRvU3RyaW5nKCkpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdH1cblxuXHRzZWxlY3RBbGwoYWxsRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMgPSBuZXcgU2V0PHN0cmluZz4oYWxsRW50aXR5SWRzLm1hcChpZCA9PiBpZC50b1N0cmluZygpKSk7XG5cdFx0dGhpcy5hbGxTZWxlY3RlZCA9IHRydWU7XG5cdFx0dGhpcy5hbGxVbnNlbGVjdGVkID0gZmFsc2U7XG5cdH1cblxuXHR1bnNlbGVjdEFsbCgpOiB2b2lkIHtcblx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcy5jbGVhcigpO1xuXHRcdHRoaXMuYWxsU2VsZWN0ZWQgPSBmYWxzZTtcblx0XHR0aGlzLmFsbFVuc2VsZWN0ZWQgPSB0cnVlO1xuXHR9XG5cblx0aW52ZXJ0U2VsZWN0ZWQoYWxsRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cblx0XHRjb25zdCBzZWxlY3RlZEl0ZW1JZHMgPSB0aGlzLmdldFNlbGVjdGVkSXRlbUlkcygpO1xuXG5cdFx0Y29uc3QgYSA9IGFsbEVudGl0eUlkcy5maWx0ZXIoKGlkKSA9PiB7XG5cdFx0XHRyZXR1cm4gIXNlbGVjdGVkSXRlbUlkcy5zb21lKChzZWxJZCkgPT4gc2VsSWQuZXF1YWxzKGlkKSk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcyA9IG5ldyBTZXQ8c3RyaW5nPihhLm1hcChpZCA9PiBpZC50b1N0cmluZygpKSk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChhbGxFbnRpdHlJZHMpO1xuXHRcdHRoaXMuY2FsY3VsYXRlQWxsVW5zZWxlY3RlZCgpO1xuXHR9XG5cblx0cmVTZWxlY3RCeUlkcyhpdGVtRW50aXRpZXM6IEFycmF5PEl0ZW1FbnRpdHk+KTogdm9pZCB7XG5cdFx0dGhpcy5zZWxlY3RCeUlkcyh0aGlzLmdldFNlbGVjdGVkSXRlbUlkcygpLm1hcChpID0+IGkuZ2V0SWQoKSksIGl0ZW1FbnRpdGllcyk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXRpZXMubWFwKGkgPT4gaS5nZXRJZCgpKSk7XG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxVbnNlbGVjdGVkKCk7XG5cdH1cblxuXHRzZWxlY3RCeUlkcyhpZHM6IEFycmF5PHN0cmluZz4sIGl0ZW1FbnRpdGllczogQXJyYXk8SXRlbUVudGl0eT4pOiB2b2lkIHtcblx0XHRpZiAoIXRoaXMuZW5hYmxlZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGNvbnN0IGl0ZW1JZHMgPSBbXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRjb25zdCBpdGVtcyA9IGl0ZW1FbnRpdGllc1xuXHRcdFx0XHQuZmlsdGVyKChpdGVtOiBJdGVtRW50aXR5KSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMubWF0Y2hlcihpdGVtLmdldFNvdXJjZUl0ZW0oKSkgPT09IGlkc1tpXTtcblx0XHRcdFx0fSlcblx0XHRcdFx0Lm1hcCgoaXRlbSkgPT4gaXRlbS5nZXRJZCgpLnRvU3RyaW5nKCkpO1xuXG5cdFx0XHRpdGVtSWRzLnB1c2goLi4uaXRlbXMpO1xuXHRcdH1cblxuXHRcdGxldCB0eXBlID0gUm93U2VsZWN0VG9nZ2xlVHlwZS5BREQ7XG5cblx0XHRpZiAodGhpcy5zZWxlY3Rpb24uaXNTaW5nbGUoKSkge1xuXHRcdFx0dHlwZSA9IFJvd1NlbGVjdFRvZ2dsZVR5cGUuTk9ORTtcblx0XHR9XG5cblx0XHRpdGVtSWRzLmZvckVhY2goKGlkKSA9PiB7XG5cdFx0XHR0aGlzLnRvZ2dsZVJvd0J5VHlwZSh0eXBlLCBpZCk7XG5cdFx0fSk7XG5cblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFNlbGVjdGVkKGl0ZW1FbnRpdGllcy5tYXAoaSA9PiBpLmdldElkKCkpKTtcblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTtcblx0fVxuXG5cdHNlbGVjdEJ5SW5kZXgoaW5kZXhlczogQXJyYXk8bnVtYmVyPiwgYWxsRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLmVuYWJsZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBpdGVtSWRzID0gaW5kZXhlcy5tYXAoKGkpID0+IHtcblx0XHRcdGlmICghYWxsRW50aXR5SWRzW2ldKSB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoJ0l0ZW0gbm90IGZvdW5kJyk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gYWxsRW50aXR5SWRzW2ldLnRvU3RyaW5nKCk7XG5cdFx0fSk7XG5cblx0XHRsZXQgdHlwZSA9IFJvd1NlbGVjdFRvZ2dsZVR5cGUuQUREO1xuXG5cdFx0aWYgKHRoaXMuc2VsZWN0aW9uLmlzU2luZ2xlKCkpIHtcblx0XHRcdHR5cGUgPSBSb3dTZWxlY3RUb2dnbGVUeXBlLk5PTkU7XG5cdFx0fVxuXG5cdFx0aXRlbUlkcy5mb3JFYWNoKChpZCkgPT4ge1xuXHRcdFx0dGhpcy50b2dnbGVSb3dCeVR5cGUodHlwZSwgaWQpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChhbGxFbnRpdHlJZHMpO1xuXHRcdHRoaXMuY2FsY3VsYXRlQWxsVW5zZWxlY3RlZCgpO1xuXHR9XG5cblx0c2VsZWN0Um93cyhpdGVtSWRzOiBBcnJheTxzdHJpbmc+LCBpdGVtRW50aXR5SWRzOiBBcnJheTxJdGVtRW50aXR5SWQ+KTogdm9pZCB7XG5cblx0fVxuXG5cdHRvZ2dsZVJvdyhpdGVtSWQ6IHN0cmluZywgdHlwZTogUm93U2VsZWN0VG9nZ2xlVHlwZSwgaXRlbUVudGl0eUlkczogQXJyYXk8SXRlbUVudGl0eUlkPik6IHZvaWQge1xuXG5cdFx0aWYgKCF0aGlzLmVuYWJsZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAodHlwZSA9PT0gUm93U2VsZWN0VG9nZ2xlVHlwZS5BREQgJiYgdGhpcy5zZWxlY3Rpb24uaXNTaW5nbGUoKSkge1xuXHRcdFx0dHlwZSA9IFJvd1NlbGVjdFRvZ2dsZVR5cGUuTk9ORTtcblx0XHR9XG5cblx0XHR0aGlzLnRvZ2dsZVJvd0J5VHlwZSh0eXBlLCBpdGVtSWQpO1xuXG5cdFx0dGhpcy5jYWxjdWxhdGVBbGxTZWxlY3RlZChpdGVtRW50aXR5SWRzKTtcblx0XHR0aGlzLmNhbGN1bGF0ZUFsbFVuc2VsZWN0ZWQoKTtcblx0fVxuXG5cdGNhbGN1bGF0ZUFsbFNlbGVjdGVkKGl0ZW1FbnRpdHlJZHM6IEFycmF5PEl0ZW1FbnRpdHlJZD4pOiB2b2lkIHtcblxuXHRcdGlmIChpdGVtRW50aXR5SWRzLmxlbmd0aCAhPT0gdGhpcy5zZWxlY3RlZEl0ZW1JZHMuc2l6ZSkge1xuXHRcdFx0dGhpcy5hbGxTZWxlY3RlZCA9IGZhbHNlO1xuXHRcdH0gZWxzZSB7XG5cblx0XHRcdGNvbnN0IHJvd3MgPSBBcnJheS5mcm9tKHRoaXMuc2VsZWN0ZWRJdGVtSWRzKTtcblx0XHRcdGxldCBlcXVhbCA9IHRydWU7XG5cblx0XHRcdHJvd3Muc29ydCgpO1xuXHRcdFx0aXRlbUVudGl0eUlkcy5zb3J0KCk7XG5cblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgcm93cy5sZW5ndGg7IGkgKz0gMSkge1xuXHRcdFx0XHRpZiAocm93c1tpXSAhPT0gaXRlbUVudGl0eUlkc1tpXS50b1N0cmluZygpKSB7XG5cdFx0XHRcdFx0ZXF1YWwgPSBmYWxzZTtcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmFsbFNlbGVjdGVkID0gZXF1YWw7XG5cdFx0fVxuXHR9XG5cblx0Y2FsY3VsYXRlQWxsVW5zZWxlY3RlZCgpOiB2b2lkIHtcblx0XHR0aGlzLmFsbFVuc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkSXRlbUlkcy5zaXplID09PSAwO1xuXHR9XG5cblx0dW5zZWxlY3RSb3coaXRlbUVudGl0eUlkOiBJdGVtRW50aXR5SWQpOiB2b2lkIHtcblx0XHRpZiAodGhpcy5zZWxlY3RlZEl0ZW1JZHMuaGFzKGl0ZW1FbnRpdHlJZC50b1N0cmluZygpKSkge1xuXHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuZGVsZXRlKGl0ZW1FbnRpdHlJZC50b1N0cmluZygpKTtcblx0XHR9XG5cdH1cblxuXHRnZXRJZCgpOiBTdHJ1Y3R1cmVJZCB7XG5cdFx0cmV0dXJuIHRoaXMuaWQ7XG5cdH1cblxuXHRnZXRUeXBlKCk6IFJvd1NlbGVjdGlvblR5cGUge1xuXHRcdHJldHVybiB0aGlzLnNlbGVjdGlvbi5nZXRUeXBlKCk7XG5cdH1cblxuXHRwcml2YXRlIHRvZ2dsZVJvd0J5VHlwZSh0eXBlOiBSb3dTZWxlY3RUb2dnbGVUeXBlLCBpdGVtSWQ6IHN0cmluZykge1xuXG5cdFx0c3dpdGNoICh0eXBlKSB7XG5cdFx0XHRjYXNlIFJvd1NlbGVjdFRvZ2dsZVR5cGUuTk9ORTpcblxuXHRcdFx0XHRpZiAodGhpcy5zZWxlY3RlZEl0ZW1JZHMuaGFzKGl0ZW1JZCkpIHtcblx0XHRcdFx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcy5kZWxldGUoaXRlbUlkKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLnNlbGVjdGVkSXRlbUlkcy5jbGVhcigpO1xuXHRcdFx0XHRcdHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmFkZChpdGVtSWQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgUm93U2VsZWN0VG9nZ2xlVHlwZS5BREQ6XG5cblx0XHRcdFx0aWYgKHRoaXMuc2VsZWN0ZWRJdGVtSWRzLmhhcyhpdGVtSWQpKSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuZGVsZXRlKGl0ZW1JZCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhpcy5zZWxlY3RlZEl0ZW1JZHMuYWRkKGl0ZW1JZCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0Y2FzZSBSb3dTZWxlY3RUb2dnbGVUeXBlLlJBTkdFOlxuXG5cdFx0XHRcdGJyZWFrO1xuXG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdH1cbn1cbiJdfQ==