!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@angular/common")):"function"==typeof define&&define.amd?define("@generic-ui/hermes",["exports","@angular/core","rxjs","rxjs/operators","@angular/common"],e):e(((t=t||self)["generic-ui"]=t["generic-ui"]||{},t["generic-ui"].hermes={}),t.ng.core,t.rxjs,t.rxjs.operators,t.ng.common)}(this,(function(t,e,n,r,o){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function a(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function u(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function c(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(u(arguments[e]));return t}var p="HERMES - COMMAND_HANDLERS",f=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return s(n,t),n.prototype.next=function(e){t.prototype.next.call(this,e)},n.decorators=[{type:e.Injectable}],n}(n.Subject),g=function(){function t(t){this.commandStream=t}return t.prototype.dispatch=function(t){this.commandStream.next(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:f}]},t}();var l=function(){function t(){for(var e=0;e<256;e++)t.byteToHex[e]=(e+256).toString(16).substr(1),t.hexToByte[t.byteToHex[e]]=e}return t.generate=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},t.getUuidV4=function(){var t=this.getRandomFromMathRandom();return t[6]=15&t[6]|64,t[8]=63&t[8]|128,t},t.uuidToString=function(t,e){void 0===e&&(e=0);var n=e,r=this.byteToHex;return r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+"-"+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]+r[t[n++]]},t.getRandomFromMathRandom=function(){for(var t=new Array(16),e=0,n=0;n<16;n++)0==(3&n)&&(e=4294967296*Math.random()),t[n]=e>>>((3&n)<<3)&255;return(t)},t.byteToHex=[],t.hexToByte={},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var h=function(){function t(t,e,n){void 0===n&&(n=l.generate()),this.aggregateId=t,this.messageType=e,this.messageId=n}return t.prototype.getMessageType=function(){return this.messageType},t.prototype.getAggregateId=function(){return this.aggregateId},t.prototype.getMessageId=function(){return this.messageId},t.prototype.toString=function(){return this.messageType},t.prototype.equalsByType=function(t){return this.getMessageType()===t.getMessageType()},t.prototype.equals=function(t){return this.getMessageType()===t.getMessageType()&&this.messageId===t.messageId},t.prototype.ofMessageType=function(t){var e=this;return Array.isArray(t)?!!t.find((function(t){return e.isMessageType(t)})):this.isMessageType(t)},t.prototype.isMessageType=function(t){return this.getMessageType()===t},t}();var y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(h),d=function(){function t(t,e,n){this.command=t,this.domainEvent=e,this.eventPublisher=n,this.commandType=this.createCommandInstance().getMessageType()}return t.prototype.forCommand=function(t){return this.commandType===t.getMessageType()},t.prototype.handleCommand=function(t){var e=this,o=this.handle(t);n.isObservable(o)?o.pipe(r.take(1)).subscribe((function(n){e.dispatchEvent(t,n)})):this.dispatchEvent(t,o)},t.prototype.dispatchEvent=function(t,e){if(this.domainEvent&&this.eventPublisher){var n=t.aggregateId,r=new this.domainEvent(n);r.setRequestCommand(t),e&&r.setPayload(e),this.eventPublisher.publish(r)}},t.prototype.createCommandInstance=function(){var t,e=[],n=this.command.constructor.length;return e.fill(void 0,0,n),new((t=this.command).bind.apply(t,c([void 0],e)))},t}();var m=new e.InjectionToken("FILTERED_COMMAND_STREAM"),v=function(t){function o(e){var n=t.call(this)||this;return e&&(n.source=e),n}return s(o,t),o.prototype.lift=function(t){var e=new o;return e.source=this,e.operator=t,e},o.prototype.ofCommand=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(this.pipe(r.filter((function(e){return t.some((function(t){return e.ofMessageType(t)}))}))))},o.prototype.ofHandler=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return(this.pipe(r.filter((function(e){return t.some((function(t){return t.forCommand(e)}))}))))},o.prototype.ofNullHandler=function(t){return this.pipe(r.filter((function(e){return!t||!t.some((function(t){return t.forCommand(e)}))})))},o.decorators=[{type:e.Injectable}],o.ctorParameters=function(){return[{type:n.Subject,decorators:[{type:e.Inject,args:[m]}]}]},o}(n.Observable),b=function(){};var E=function(){function t(t,e){this.dispatcher=t,this.bus=e,this.unsubscribe$=new n.Subject,this.subscriptions=[]}return t.prototype.dispatch=function(t){return this.dispatcher.dispatch(t),t.getMessageId()},t.prototype.dispatchAndWait=function(t){var e=this,n=this.bus.pipe(r.filter((function(e){return e.fromCommand(t)})),r.first(),r.map((function(t){return e.mapEventToResponse(t)})),r.takeUntil(this.unsubscribe$)),o=setTimeout((function(){e.dispatcher.dispatch(t)}));return this.subscriptions.push(o),n},t.prototype.ngOnDestroy=function(){this.unsubscribe$.next(),this.unsubscribe$.complete(),this.subscriptions.forEach((function(t){clearTimeout(t)}))},t}();var S=function(){function t(t,e){this.aggregateId=t,this.type=e}return t.prototype.getAggregateId=function(){return this.aggregateId},t.prototype.getType=function(){return this.type},t.prototype.equals=function(t){return this.equalsByType(t)&&this.getAggregateId().equals(t.getAggregateId())},t.prototype.equalsByType=function(t){return this.getType()===t.getType()},t}();var I=function(){};var A=function(){function t(){this.stores=[]}return t.prototype.register=function(t){this.stores.push(t)},t.prototype.captureAggregatesSnapshot=function(t){if(!t)return{};var e={};return this.stores.forEach((function(n){var r=n.getById(t);if(r){var o=r.constructor.name;e[o]=r}})),this.cloneAggregates(e)},t.prototype.cloneAggregates=function(t){return JSON.parse(JSON.stringify(t))},t}();var M=function(){function t(t){this.aggregateId=t,this.events=[]}return t.prototype.getId=function(){return this.aggregateId},t.prototype.getEvents=function(){return this.events},t.prototype.addEvent=function(t){this.events.push(t)},t.prototype.clearEvents=function(){this.events.length=0},t}();var T=function(){function t(t){this.uid=t}return t.prototype.toString=function(){return this.uid},t.prototype.getId=function(){return this.uid},t.prototype.equals=function(t){return this.uid===t.getId()},t}();var C={SUCCESS:0,FAILURE:1};C[C.SUCCESS]="SUCCESS",C[C.FAILURE]="FAILURE";var x=function(){function t(t,e){this.status=t,this.payload=e}return t.prototype.getStatus=function(){return this.status},t.prototype.getPayload=function(){return this.payload},t}();var R=function(t){function e(e,n,r){var o=t.call(this,e,n)||this;return o.payload=r,o}return s(e,t),e.prototype.isSameType=function(t){return this.constructor.name===t.constructor.name},e.prototype.setRequestCommand=function(t){this.requestCommandId=t.getMessageId()},e.prototype.fromCommand=function(t){return t.getMessageId()===this.requestCommandId},e.prototype.setPayload=function(t){this.payload=t},e.prototype.getPayload=function(){return this.payload},e}(h);var L=function(){function t(){this.domainEvents=[],this.domainEvents$=new n.Subject}return t.prototype.next=function(t){this.domainEvents.push(t),this.domainEvents$.next(t)},t.prototype.findEventByType=function(t){return this.getEvents().reverse().find((function(e){return e.constructor.name===t}))},t.prototype.waitForEvent=function(t){var e=this.findEventByType(t);return e?n.of(e):this.waitForNextEventOccurrence(t)},t.prototype.waitForNextEventOccurrence=function(t){var e;if(t instanceof R)e=t.constructor.name;else{if("string"!=typeof t)return n.throwError(new Error("Unsupported argument type."));e=t}return this.domainEvents$.pipe(r.filter((function(t){return t.constructor.name===e})),r.take(1))},t.prototype.getEvents=function(){return this.domainEvents},t.decorators=[{type:e.Injectable}],t}();var D=function(t){function n(e){var n=t.call(this)||this;return n.eventStore=e,n}return s(n,t),n.prototype.next=function(e){t.prototype.next.call(this,e),this.eventStore.next(e)},n.decorators=[{type:e.Injectable}],n.ctorParameters=function(){return[{type:L}]},n}(n.Subject);var w=function(){function t(t){this.eventStream=t}return t.prototype.publish=function(t){var e,n;if(Array.isArray(t))try{for(var r=a(t),o=r.next();!o.done;o=r.next()){var i=o.value;this.publishEvent(i)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}else t instanceof R&&this.publishEvent(t)},t.prototype.dispatchAggregateEvent=function(t,e){},t.prototype.publishEvent=function(t){this.eventStream.next(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:D}]},t}();var O=function(t){function n(e){var n=t.call(this)||this;return e&&(n.source=e),n}return s(n,t),n.prototype.lift=function(t){var e=new n;return e.source=this,e.operator=t,e},n.prototype.ofEvent=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(this.pipe(r.filter((function(n){return e.some((function(e){return t.createEventInstance(e).equalsByType(n)}))}))))},n.prototype.createEventInstance=function(t){var e=[],n=t.constructor.length;return e.fill(void 0,0,n),new(t.bind.apply(t,c([void 0],e)))},n.decorators=[{type:e.Injectable}],n.ctorParameters=function(){return[{type:D}]},n}(n.Observable),j=function(){};var N=function(){};var _=function(){function t(t){this.value=t}return t.prototype.getValue=function(){return this.value},t}();var P="DOMAIN_EVENT_HANDLERS",B=function(){function t(t){this.aggregateId=t}return t.prototype.getId=function(){return this.aggregateId},t}();var H=function(){};var $=function(){function t(){this.archive=new Map,this.archive$=new n.ReplaySubject}return t.prototype.set=function(t,e){this.archive.set(t.toString(),e),this.archive$.next(this.archive)},t.prototype.select=function(t){return this.archive$.asObservable().pipe(r.map((function(e){return e.get(t.toString())})),r.distinctUntilChanged())},t}();var q="hermesApi",G=function(){function t(t,e,n){if(this.platformId=t,this.commandLogger=e,this.eventLogger=n,o.isPlatformBrowser(this.platformId)){window[q]=function(t){return{set loggers(e){e?(t.commandLogger.start(),t.eventLogger.start()):(t.commandLogger.stop(),t.eventLogger.stop())}}}(this),window[q].loggers=!1}}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:Object,decorators:[{type:e.Inject,args:[e.PLATFORM_ID]}]},{type:b},{type:N}]},t}();var U=function(){function t(t){this.aggregateId=t}return t.prototype.getAggregateId=function(){return this.aggregateId},t.prototype.getId=function(){return this.aggregateId.toString()},t}();var V=function(){function t(){this.state=new Map}return t.prototype.set=function(t){this.state.set(t.getId(),t)},t.prototype.setMany=function(t){var e=this;t.forEach((function(t){e.set(t)}))},t.prototype.get=function(t){return this.state.get(t.toString())},t.prototype.getAll=function(){return Array.from(this.state.values())},t.prototype.clear=function(){this.state.clear()},t}();var k=function(t){function e(e){var n=t.call(this)||this;return n.stateStore=e,n}return s(e,t),e.prototype.getById=function(t){return this.getValue(t)},e.prototype.getAll=function(){return this.getAllValues()},e.prototype.getAllValues=function(){var t=this;return this.stateStore.getAll().map((function(e){return t.fromAnemia(e)}))},e.prototype.getValue=function(t){var e=this.stateStore.get(t);return e?this.fromAnemia(e):null},e}(H);var F=function(t){function e(e,n){var r=t.call(this)||this;return r.stateStore=e,r.aggregateStoreRegister=n,r.aggregateStoreRegister.register(r),r}return s(e,t),e.prototype.save=function(t){this.saveValue(t)},e.prototype.getById=function(t){return this.getValue(t)},e.prototype.saveValue=function(t){var e=this.toAnemia(t);this.stateStore.set(e)},e.prototype.getValue=function(t){var e=this.stateStore.get(t);return e?this.fromAnemia(e):null},e}(I);var J=function(t){function e(e,n){var r=t.call(this)||this;return r.inMemoryStore=e,r.aggregateStoreRegister=n,r.aggregateStoreRegister.register(r),r}return s(e,t),e.prototype.save=function(t){var e=this;if(Array.isArray(t))t.forEach((function(t){e.inMemoryStore.set(t)}));else{var n=t;this.inMemoryStore.set(n)}},e.prototype.getById=function(t){return this.inMemoryStore.get(t)},e.prototype.getAll=function(){return this.inMemoryStore.getAll()},e.prototype.remove=function(t){this.inMemoryStore.delete(t)},e}(I);var W=function(t){function e(e){var n=t.call(this)||this;return n.inMemoryStore=e,n}return s(e,t),e.prototype.getById=function(t){return this.getValue(t)},e.prototype.getAll=function(){var t=this;return this.inMemoryStore.getAll().map((function(e){return t.toReadModel(e)}))},e.prototype.getValue=function(t){var e=this.inMemoryStore.get(t);return e?this.toReadModel(e):null},e}(H);var Y=function(){function t(){this.state=new Map}return t.prototype.set=function(t){this.state.set(t.getId().toString(),t)},t.prototype.setMany=function(t){var e=this;t.forEach((function(t){e.set(t)}))},t.prototype.get=function(t){return this.state.get(t.toString())},t.prototype.getAll=function(){return Array.from(this.state.values())},t.prototype.has=function(t){return this.state.has(t.toString())},t.prototype.delete=function(t){this.state.delete(t.toString())},t.prototype.clear=function(){this.state.clear()},t}();var z=function(t){function o(e){var o=t.call(this)||this;return o.enabled=!1,o.unsubscribe$=new n.Subject,e.pipe(r.filter((function(){return o.enabled})),r.takeUntil(o.unsubscribe$)).subscribe((function(t){o.log(t)})),o}return s(o,t),o.prototype.ngOnDestroy=function(){this.unsubscribe$.next(),this.unsubscribe$.complete()},o.prototype.start=function(){this.enabled=!0},o.prototype.stop=function(){this.enabled=!1},o.prototype.log=function(t){console.log(t.toString(),t)},o.decorators=[{type:e.Injectable}],o.ctorParameters=function(){return[{type:v}]},o}(b);var K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.start=function(){},e.prototype.stop=function(){},e.prototype.log=function(t){},e}(b),Q=function(t){function o(e,o){var i=t.call(this)||this;return i.aggregateStoreRegister=o,i.enabled=!1,i.unsubscribe$=new n.Subject,e.pipe(r.filter((function(){return i.enabled})),r.takeUntil(i.unsubscribe$)).subscribe((function(t){i.log(t)})),i}return s(o,t),o.prototype.ngOnDestroy=function(){this.unsubscribe$.next(),this.unsubscribe$.complete()},o.prototype.start=function(){this.enabled=!0},o.prototype.stop=function(){this.enabled=!1},o.prototype.log=function(t){var e=t.aggregateId,n=this.aggregateStoreRegister.captureAggregatesSnapshot(e);console.log(t.toString(),t,n)},o.decorators=[{type:e.Injectable}],o.ctorParameters=function(){return[{type:O},{type:A}]},o}(N);var X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.start=function(){},e.prototype.stop=function(){},e.prototype.log=function(t){},e}(N),Z=c([{provide:"GUI - EVENT_LOGGER_ENABLED",useValue:!0},{provide:"GUI - COMMAND_LOGGER_ENABLED",useValue:!0},{provide:b,useFactory:tt,deps:["GUI - COMMAND_LOGGER_ENABLED",z,K]},{provide:N,useFactory:et,deps:["GUI - EVENT_LOGGER_ENABLED",Q,X]},z,K,X,Q],[l,{provide:m,useExisting:f},v,f,g,A,O,D,w,L,G]);function tt(t,e,n){return t?e:n}function et(t,e,n){return t?e:n}var nt=function(){function t(t,e,o,i,s,a,u){var c=this;this.commandLogger=s,this.eventLogger=a,this.hermesApi=u,this.unsubscribe$=new n.Subject,this.loggersStart(),this.checkNullCommand(o,t),this.checkCommandHandlerIsCollection(t),t&&t.forEach((function(t){o.ofHandler(t).pipe(r.takeUntil(c.unsubscribe$)).subscribe((function(e){t.handleCommand(e)}))})),e&&i.pipe(r.takeUntil(this.unsubscribe$)).subscribe((function(t){e.forEach((function(e){e.handle(t)}))}))}return t.withConfig=function(e){return void 0===e&&(e={loggers:!1}),{ngModule:t,providers:Z}},t.prototype.ngOnDestroy=function(){this.unsubscribe$.next(),this.unsubscribe$.complete(),this.loggersStop()},t.prototype.loggersStart=function(){this.commandLogger.start(),this.eventLogger.start()},t.prototype.loggersStop=function(){this.commandLogger.stop(),this.eventLogger.stop()},t.prototype.checkNullCommand=function(t,e){t.ofNullHandler(e).pipe(r.takeUntil(this.unsubscribe$)).subscribe((function(t){console.log("Command "+t.toString()+" was not intercepted by any CommandHandler.")}))},t.prototype.checkCommandHandlerIsCollection=function(t){t&&!Array.isArray(t)&&console.log('You might provided commandHandler without specifying "multi: true".')},t.decorators=[{type:e.NgModule,args:[{imports:[o.CommonModule],providers:Z}]}],t.ctorParameters=function(){return[{type:Array,decorators:[{type:e.Optional},{type:e.Inject,args:[p]}]},{type:Array,decorators:[{type:e.Optional},{type:e.Inject,args:[P]}]},{type:v},{type:O},{type:b},{type:N},{type:G}]},t}();t.Aggregate=M,t.AggregateEvent=S,t.AggregateId=T,t.AggregateStore=I,t.AggregateStoreRegister=A,t.COMMAND_HANDLERS=p,t.COMMAND_LOGGER_ENABLED="GUI - COMMAND_LOGGER_ENABLED",t.Command=y,t.CommandBus=v,t.CommandDispatcher=g,t.CommandHandler=d,t.CommandLogger=b,t.CommandStream=f,t.DOMAIN_EVENT_HANDLERS=P,t.DomainEvent=R,t.DomainEventBus=O,t.DomainEventHandler=j,t.DomainEventLogger=N,t.DomainEventPayload=_,t.DomainEventPublisher=w,t.DomainEventStatus=C,t.DomainEventStream=D,t.EVENT_LOGGER_ENABLED="GUI - EVENT_LOGGER_ENABLED",t.HermesApi=G,t.HermesModule=nt,t.InMemoryAggregateStore=J,t.InMemoryReadModelStore=W,t.InMemoryStore=Y,t.PersistAggregateStore=F,t.PersistAnemia=U,t.PersistReadModelStore=k,t.PersistStateStore=V,t.RandomStringGenerator=l,t.ReactiveAggregateArchive=$,t.ReadModel=B,t.ReadModelStore=H,t.ReplayCommandDispatcher=E,t.StatusResponse=x,t.assertAggregateEvents=function(t,e){var n,r;expect(t.length).toEqual(e.length,"Aggregate events");var o=function(t){var n=e.find((function(e){return e.equals(t)}));expect(n).toBeDefined()};try{for(var i=a(t),s=i.next();!s.done;s=i.next()){o(s.value)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},t.assertDomainEvents=function(t,e){var n,r;expect(t.length).toEqual(e.length);var o=function(t){var n=e.find((function(e){return e.equalsByType(t)}));expect(n).toBeDefined(),expect(t.equalsByType(n)).toBeTruthy("Event type should be equal"),expect(t.getPayload()).toEqual(n.getPayload(),"Events payload should be the same")};try{for(var i=a(t),s=i.next();!s.done;s=i.next()){o(s.value)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},t.disableHermesLoggers=function(){window[q].loggers=!1},t.enableHermesLoggers=function(){window[q].loggers=!0},t.provideCommandHandlers=function(t){return t.map((function(t){return{provide:p,useClass:t,multi:!0}}))},t.provideEventHandlers=function(t){return t.map((function(t){return{provide:P,useClass:t,multi:!0}}))},t.ɵa=tt,t.ɵb=et,t.ɵc=h,t.ɵd=L,t.ɵe=m,t.ɵf=z,t.ɵg=K,t.ɵh=Q,t.ɵi=X,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=generic-ui-hermes.umd.min.js.map